<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wolfking.jeesite.modules.mq.dao.OrderReportDao">

    <sql id="messageColumns">
        a.id,
        a.order_id,
        a.order_type,
        a.province_id,
        a.province_name,
        a.city_id,
        a.city_name,
        a.area_id,
        a.area_name,
        a.customer_id,
        a.payment_type,
        a.qty,
        a.amount,
        a.trigger_by as "kefu.id",
        a.trigger_date,
        a.data_quarter,
        a.retry_times,
        a.description as remarks
    </sql>

    <!-- 待重送记录 -->
    <select id="getResendList" parameterType="java.util.Map" resultType="com.wolfking.jeesite.modules.mq.entity.OrderReport">
        /*#mycat:db_type=master*/
        select <include refid="messageColumns" />,'' as "kefu.name"
        from mq_order_report a
        where a.status in(10,40)
        <if test="id != null">
            and a.id = #{id}
        </if>
        <if test="orderId != null">
            and a.order_id = #{orderId}
        </if>
        <if test="orderType != null">
            and a.order_type = #{orderType}
        </if>
        <if test="startDate != null">
            <![CDATA[ and a.trigger_date >= #{startDate} ]]>
        </if>
        <if test="endDate != null">
            <![CDATA[ and a.trigger_date <= #{endDate} ]]>
        </if>
        <![CDATA[ AND a.retry_times < 3 ]]>
        order by a.trigger_date
        <if test="num != null and num>0">
            limit #{num}
        </if>
    </select>

    <insert id="insert">
        INSERT INTO mq_order_report
        (
         order_id,order_type,province_id,province_name,city_id,city_name,area_id,area_name,
         customer_id,payment_type,
         qty,amount,trigger_by,trigger_date,data_quarter,
         status,retry_times,create_date,description
        )
        VALUES
        (
         #{orderId},#{orderType},#{provinceId},#{provinceName},#{cityId},#{cityName},#{areaId},#{areaName},
         <choose>
              <when test="customer != null and customer.id != null and customer.id >0">
                  #{customer.id},
              </when>
             <otherwise>
                 0,
             </otherwise>
         </choose>
        <choose>
            <when test="customer != null and customer.paymentType != null and customer.paymentType != 0">
                #{customer.paymentType},
            </when>
            <otherwise>
                0,
            </otherwise>
        </choose>
         #{qty},#{amount},#{triggerBy},#{triggerDate},#{dataQuarter},
         #{status},#{retryTimes},now(),#{remarks}
        )
    </insert>

    <update id="update">
        update mq_order_report
        set
          <if test="retryTimes != null and retryTimes>0">
          retry_times = retry_times + 1,
          </if>
          status = #{status},
          remarks = #{remarks},
          update_date = now()
        where id = #{id}
    </update>

    <update id="updateByOrderIdAndType">
        update mq_order_report
        set
        <if test="retryTimes != null and retryTimes>0">
            retry_times = retry_times + 1,
        </if>
        status = #{status},
        remarks = #{remarks},
        update_date = #{updateDate}
        where order_id = #{orderId}
        and order_type = #{orderType}
    </update>

</mapper>