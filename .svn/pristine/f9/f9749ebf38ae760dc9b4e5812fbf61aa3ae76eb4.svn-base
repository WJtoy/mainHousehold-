<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wolfking.jeesite.modules.md.dao.ServicePointDao">

    <select id="getServicePointBalances" resultType="java.util.HashMap" >
        select id,balance,last_pay_date,last_pay_amount
        from  md_servicepoint_finance
        where id in
        <foreach collection="servicePointIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>


    <insert id="insertFI">
        INSERT INTO md_servicepoint_finance (
        id,
        payment_type,
        bank,
        branch,
        bank_no ,
        bank_owner,
        bank_issue,
        order_payment_amount,
        debts_amount,
        debts_descrption,
        refund_amount ,
        replenish_amount,
        balance,
        total_amount,
        invoice_flag,
        discount,
        discount_flag,
        unit
        ) VALUES (
        #{id},
        #{paymentType.value},
        #{bank.value},
        #{branch},
        #{bankNo},
        #{bankOwner},
        #{bankIssue.value},
        #{orderPaymentAmount},
        #{debtsAmount},
        #{debtsDescrption},
        #{refundAmount},
        #{replenishAmount},
        #{balance},
        #{totalAmount},
        #{invoiceFlag},
        #{discount},
        #{discountFlag},
        #{unit.value}
        )
    </insert>

    <update id="updateFI">
        UPDATE md_servicepoint_finance
        SET
            payment_type = #{paymentType.value},
            bank = #{bank.value},
            branch = #{branch},
            bank_no = #{bankNo},
            bank_owner = #{bankOwner},
            bank_issue = #{bankIssue.value},
            unit = #{unit.value},
            invoice_flag = #{invoiceFlag},
            discount = #{discount},
            discount_flag = #{discountFlag}
            <if test="debtsDescrption != null">
                , debts_descrption = #{debtsDescrption}
            </if>
            <if test="debtsAmount != null">
                , debts_amount = #{debtsAmount}
            </if>
        WHERE
          id = #{id}
    </update>

    <update id="approve" >
        update md_servicepoint
        set del_flag = 0,
        update_by = #{updateBy},
        update_date = now()
        where id in
        <foreach collection="ids" item="id" index="index"
                 open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <select id="getEngineerByPhoneExpect" resultType="User">
        select id,name
        from sys_user
        where login_name = #{mobile}
            <![CDATA[and del_flag != 0]]>
        <if test="exceptId != null and exceptId > 0">
            <![CDATA[
                and engineer_id <> #{exceptId}
              ]]>
        </if>
        limit 1
    </select>

    <update id="updateUser">
        UPDATE
          sys_user
        SET
          login_name = #{contactInfo},
          mobile = #{contactInfo},
          name = #{name},
          qq = #{qq},
          update_by = #{updateBy.id},
          update_date = #{updateDate}
          <if test="masterFlag == 1">,sub_flag = 0</if>
          <if test="masterFlag == 0">,sub_flag = 1</if>
        where engineer_id = #{id}
    </update>

    <!-- 重置安维帐号密码 -->
    <update id="resetPassword">
        update sys_user
        SET
          password = #{password},
          update_by = #{updateBy.id},
          update_date = #{updateDate}
        where engineer_id = #{engineerId}
    </update>

    <delete id="deleteUser">
        update sys_user
        set del_flag = #{delFlag},
        update_by = #{updateBy.id},
        update_date = #{updateDate}
        where engineer_id = #{id}
    </delete>

    <update id="resetUserEngineerSubFlag">
        update sys_user
        set sub_flag = 1
        where engineer_id in
        <foreach item="engineerId" index="index" collection="list" open="(" separator="," close=")">
          #{engineerId}
        </foreach>
    </update>

    <select id="findAllFinanceList" resultType="ServicePointFinance">
        SELECT  id,
                 payment_type as "paymentType.value",
                '' as "paymentType.label",
                bank as "bank.value",
                '' as "bank.label",
                branch,
                bank_no,
                bank_owner,
                bank_issue as "bankIssue.value",
                ''   as "bankIssue.label",
                invoice_flag,
                discount_flag,
                discount,
                last_pay_date,
                last_pay_amount,
                balance,
                debts_amount,
                debts_descrption,
                insurance_amount,
                info_fee,
                tax_fee
          FROM md_servicepoint_finance
    </select>

    <select id="findFinanceListByIds" resultType="ServicePointFinance">
        SELECT id,
            payment_type as "paymentType.value",
            '' as "paymentType.label",
            bank as "bank.value",
            '' as "bank.label",
            bank_no as "bankNo",
            bank_owner as "bankOwner",
            invoice_flag as "invoiceFlag",
            discount_flag as "discountFlag"
        FROM  md_servicepoint_finance
        WHERE id in
            <foreach collection="ids" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
    </select>

    <select id="getFinanceNew" resultType="ServicePointFinance">
        SELECT fi.id AS "id",
                fi.invoice_flag AS "invoiceFlag",
                fi.discount as "discount",
                fi.payment_type as "paymentType.value",
                '' as "paymentType.label",
                fi.bank as "bank.value",
                '' as "bank.label",
                fi.branch as "branch",
                fi.bank_no as "bankNo",
                fi.bank_owner as "bankOwner",
                fi.bank_issue as "bankIssue.value",
                '' as "bankIssue.label",
                fi.balance as "balance",
                fi.last_pay_date as "lastPayDate",
                fi.last_pay_amount as "lastPayAmount",
                fi.order_payment_amount as "orderPaymentAmount",
                fi.debts_amount as "debtsAmount",
                fi.debts_descrption as "debtsDescrption",
                fi.refund_amount as "refundAmount",
                fi.replenish_amount as "replenishAmount",
                fi.total_amount as "totalAmount",
                fi.invoice_flag as "invoiceFlag",
                fi.discount_flag as "discountFlag",
                fi.deposit as "deposit",
                fi.unit as "unit.value",
                '' as "unit.label"
        FROM md_servicepoint_finance fi
        where fi.id = #{id}
    </select>

    <select id="getFinanceForDiscount" resultType="ServicePointFinance">
        select id,
               discount
        from md_servicepoint_finance
        where id = #{id}
    </select>

    <select id="getFinanceFromMaster" resultType="ServicePointFinance">
        /*!mycat:db_type=master*/
        SELECT fi.id AS "id",
                fi.invoice_flag AS "invoiceFlag",
                fi.discount as "discount",
                fi.payment_type as "paymentType.value",
                '' as "paymentType.label",
                fi.bank as "bank.value",
                '' as "bank.label",
                fi.branch as "branch",
                fi.bank_no as "bankNo",
                fi.bank_owner as "bankOwner",
                fi.bank_issue as "bankIssue.value",
                '' as "bankIssue.label",
                fi.balance as "balance",
                fi.last_pay_date as "lastPayDate",
                fi.last_pay_amount as "lastPayAmount",
                fi.order_payment_amount as "orderPaymentAmount",
                fi.debts_amount as "debtsAmount",
                fi.debts_descrption as "debtsDescrption",
                fi.refund_amount as "refundAmount",
                fi.replenish_amount as "replenishAmount",
                fi.total_amount as "totalAmount",
                fi.invoice_flag as "invoiceFlag",
                fi.discount_flag as "discountFlag",
                fi.deposit as "deposit",
                fi.unit as "unit.value",
                '' as "unit.label"
        FROM md_servicepoint_finance fi
        where fi.id = #{id}
    </select>

    <select id="getFinance" resultType="ServicePointFinance">
        SELECT
            a.id,
            a.payment_type            AS 'paymentType.value',
            a.bank                    AS 'bank.value',
            a.branch,
            a.bank_no,
            a.bank_owner,
            a.bank_issue              AS 'bankIssue.value',
            a.order_payment_amount,
            a.debts_amount,
            a.refund_amount,
            a.replenish_amount,
            a.balance,
            a.daily_balance,
            a.last_pay_date,
            a.total_amount,
            a.invoice_flag,
            a.insurance_amount
        FROM
            md_servicepoint_finance a
        WHERE
            a.id =#{id}
    </select>

    <select id="getFinanceForRestBalance" resultType="ServicePointFinance">
        SELECT
        a.order_payment_amount,
        a.debts_amount,
        a.refund_amount,
        a.replenish_amount,
        a.balance,
        a.daily_balance,
        a.last_pay_date,
        a.total_amount,
        a.invoice_flag,
        a.insurance_amount
        FROM
        md_servicepoint_finance a
        WHERE
        a.id =#{id}
    </select>

    <select id="getAmounts" resultType="ServicePointFinance">
        SELECT
            a.id,
            a.order_payment_amount,
            a.debts_amount,
            a.refund_amount,
            a.replenish_amount,
            a.balance,
            a.total_amount,
            a.insurance_amount,
            a.bank_issue              AS 'bankIssue.value'
        FROM
            md_servicepoint_finance a
        WHERE
            a.id =#{id}
    </select>

    <select id="getBalanceById" resultType="ServicePointFinance">
        SELECT
            id,
            balance
        FROM
            md_servicepoint_finance
        WHERE
            id = #{servicePointId}
    </select>

    <select id="getBalanceAndDiscountAndDeposit" resultType="ServicePointFinance">
        SELECT
            a.id,
            a.balance,
            a.discount,
            a.discount_flag,
            a.deposit
        FROM
            md_servicepoint_finance a
        WHERE
            a.id IN
            <foreach item="servicePointId" index="index" collection="servicePointIds" open="(" separator="," close=")">
                #{servicePointId}
            </foreach>
    </select>

    <select id="getBalanceAndDiscountById" resultType="ServicePointFinance">
        SELECT
        a.id,
        a.balance,
        a.discount,
        a.discount_flag
        FROM
        md_servicepoint_finance a
        WHERE
        a.id = #{servicePointId}
    </select>

    <select id="getDiscountFlagById" resultType="ServicePointFinance">
        SELECT
            a.discount,
            a.discount_flag
        FROM
            md_servicepoint_finance a
        WHERE
            a.id = #{servicePointId}
    </select>

    <update id="updateBalance" parameterType="ServicePointFinance">
        UPDATE
            md_servicepoint_finance
        <set>
              balance = balance + #{balance},
            <if test="dailyBalance != 0">
                daily_balance = daily_balance + #{dailyBalance},
            </if>
            <if test="taxFee != 0">
                tax_fee = tax_fee + #{taxFee},
            </if>
            <if test="infoFee != 0">
                info_fee = info_fee + #{infoFee},
            </if>
            <if test="deposit != 0">
                deposit = deposit + #{deposit},
            </if>
        </set>
        WHERE
            id = #{id}
    </update>

    <update id="updateBankIssueFI" parameterType="servicePointFinance">
        UPDATE
            md_servicepoint_finance
        SET
            bank_issue = #{bankIssue.value}
        WHERE
            id = #{id}
    </update>

    <update id="payServicePoint" parameterType="servicePointFinance">
        UPDATE
            md_servicepoint_finance
        <set>
            bank_issue = 0,
            <if test="balance != 0">
              balance = balance + #{balance},
            </if>
            <if test="platformFee != 0">
              platform_fee = platform_fee + #{platformFee},
            </if>
            <if test="debtsAmount != 0">
              debts_amount = debts_amount + #{debtsAmount},
            </if>
            <if test="totalAmount != 0">
              total_amount = total_amount + #{totalAmount},
            </if>
            <if test="lastPayDate != null">
                last_pay_date = #{lastPayDate},
            </if>
            <if test="lastPayAmount != 0">
                last_pay_amount = #{lastPayAmount},
            </if>
            <if test="dailyBalance != 0">
                daily_balance = daily_balance + #{dailyBalance},
            </if>
            <if test="insuranceAmount != 0">
                insurance_amount = insurance_amount + #{insuranceAmount},
            </if>
        </set>
        WHERE
            id =#{id}
    </update>

    <select id="getPayableDailyListWithoutServicePoint" resultType="ServicePointPayCondition">
        SELECT
            msf.id    AS 'servicePointId',
            20        AS 'paymentType',
            msf.bank
        FROM
            md_servicepoint_finance msf
        WHERE daily_balance > 0
        <if test="exceptBankIds != null and exceptBankIds.size > 0">
            AND msf.bank NOT IN
            <foreach item="exceptBankId" index="index" collection="exceptBankIds" open="(" separator="," close=")">
                #{exceptBankId}
            </foreach>
        </if>
        ORDER BY
            msf.bank
            LIMIT 50000;
    </select>

    <select id="getPayableMonthlyListWithoutServicePoint" resultType="ServicePointPayCondition">
        SELECT
            msf.id    AS 'servicePointId',
            10        AS 'paymentType',
            msf.bank
        FROM
            md_servicepoint_finance msf
            INNER JOIN(
                SELECT
                    DISTINCT payable.servicepoint_id AS id
                FROM
                    fi_servicepoint_payable_monthly payable
                    INNER JOIN
                      fi_servicepoint_paid_monthly paid
                    ON	payable.id = paid.id
                        AND payable.payment_type = 10
                        AND paid.payment_type = 10
                WHERE (payable.m1+payable.m2+payable.m3+payable.m4+payable.m5+payable.m6+payable.m7+payable.m8+payable.m9+payable.m10+payable.m11+payable.m12) -
                    (paid.m1+paid.m2+paid.m3+paid.m4+paid.m5+paid.m6+paid.m7+paid.m8+paid.m9+paid.m10+paid.m11+paid.m12) > 0
                LIMIT 50000
            )payabler
        ON msf.id = payabler.id AND msf.balance > 0
        <if test="exceptBankIds != null and exceptBankIds.size > 0">
            WHERE msf.bank NOT IN
            <foreach item="exceptBankId" index="index" collection="exceptBankIds" open="(" separator="," close=")">
                #{exceptBankId}
            </foreach>
        </if>
        ORDER BY
        msf.bank
        LIMIT 50000;
    </select>

    <select id="getPayableDailyDetailListWithoutServicePoint" resultType="ServicePoint">
        SELECT
            msf.id                  AS 'id',
            msf.id                  AS 'finance.id',
            msf.invoice_flag        AS 'finance.invoiceFlag',
            msf.discount_flag       AS 'finance.discountFlag',
            20                      AS 'finance.paymentType.value',
            msf.debts_amount        AS 'finance.debtsAmount',
            msf.debts_descrption    AS 'finance.debtsDescrption',
            msf.bank                AS 'finance.bank.value',
            msf.branch              AS 'finance.branch',
            msf.bank_no             AS 'finance.bankNo',
            msf.bank_owner          AS 'finance.bankOwner',
            msf.bank_issue          AS 'finance.bankIssue.value',
            msf.daily_balance       AS 'finance.payableAmount'
        FROM
              md_servicepoint_finance msf
        <where>
            <if test="finance.id != null">
                AND msf.id = #{finance.id}
            </if>
            <if test="finance.bank != null and finance.bank.value != null">
                AND msf.bank = #{finance.bank.value}
            </if>
            <if test="finance.bankIssue != null and finance.bankIssue.value != null">
                <if test="finance.bankIssue.value == 0">
                    AND msf.bank_issue = 0
                </if>
                <if test="finance.bankIssue.value == 1">
                    AND msf.bank_issue > 0
                </if>
            </if>
            <if test="finance.invoiceFlag != null">
                AND msf.invoice_flag = #{finance.invoiceFlag}
            </if>
            <if test="finance.discountFlag != null">
                AND msf.discount_flag = #{finance.discountFlag}
            </if>
            AND msf.daily_balance > 0 AND msf.balance > 0
            <if test="exceptBankIds != null and exceptBankIds.size > 0">
                AND msf.bank NOT IN
                <foreach item="exceptBankId" index="index" collection="exceptBankIds" open="(" separator="," close=")">
                    #{exceptBankId}
                </foreach>
            </if>
        </where>
        LIMIT 50000;
    </select>

    <select id="findServicePointIdsFromFinance" resultType="Long">
        SELECT
            msf.id                  AS 'id'
        FROM  md_servicepoint_finance msf
        <where>
            <if test="invoiceFlag != null and invoiceFlag >=0">
                AND msf.invoice_flag = #{invoiceFlag}
            </if>
            <if test="discountFlag != null and discountFlag >=0">
                AND msf.discount_flag = #{discountFlag}
            </if>
        </where>
        LIMIT 2000;
    </select>

    <select id="getPayableMonthlyDetailListWithoutServicePoint" resultType="ServicePoint">
        SELECT
                msf.id                  AS 'id',
                msf.id                  AS 'finance.id',
                msf.invoice_flag        AS 'finance.invoiceFlag',
                msf.discount_flag       AS 'finance.discountFlag',
                10                      AS 'finance.paymentType.value',
                msf.debts_amount        AS 'finance.debtsAmount',
                msf.debts_descrption    AS 'finance.debtsDescrption',
                msf.bank                AS 'finance.bank.value',
                msf.branch              AS 'finance.branch',
                msf.bank_no             AS 'finance.bankNo',
                msf.bank_owner          AS 'finance.bankOwner',
                msf.bank_issue          AS 'finance.bankIssue.value',
                payable.${finance.payableMonthField} - IFNULL(paid.${finance.payableMonthField},0)
                                        AS 'finance.payableAmount'
        FROM
                fi_servicepoint_payable_monthly payable
        LEFT JOIN
                fi_servicepoint_paid_monthly paid
            ON	payable.id = paid.id
            AND payable.payment_type = 10
            AND paid.payment_type = 10
        INNER JOIN
                rpt_servicepoint_balance_monthly balance
            ON	payable.id = balance.id
            AND payable.payment_type = 10
            AND balance.payment_type = 10
        INNER JOIN
                md_servicepoint_finance msf
            ON  payable.servicepoint_id = msf.id
        <where>
            <if test="finance.id != null">
                AND payable.servicepoint_id = #{finance.id}
            </if>
            AND payable.year = #{finance.payableYear}
            AND payable.${finance.payableMonthField} - IFNULL(paid.${finance.payableMonthField},0) > 0
            AND balance.${finance.payableMonthField} > 0
            AND msf.balance > 0
            <if test="finance.bank != null and finance.bank.value != null">
                AND msf.bank = #{finance.bank.value}
            </if>
            <if test="finance.bankIssue != null and finance.bankIssue.value != null">
                <if test="finance.bankIssue.value == 0">
                  AND msf.bank_issue = 0
                </if>
                <if test="finance.bankIssue.value == 1">
                  AND msf.bank_issue > 0
                </if>
            </if>
            <if test="finance.invoiceFlag != null">
                AND msf.invoice_flag = #{finance.invoiceFlag}
            </if>
            <if test="finance.discountFlag != null">
                AND msf.discount_flag = #{finance.discountFlag}
            </if>
            <if test="exceptBankIds != null and exceptBankIds.size > 0">
                AND msf.bank NOT IN
                <foreach item="exceptBankId" index="index" collection="exceptBankIds" open="(" separator="," close=")">
                    #{exceptBankId}
                </foreach>
            </if>
        </where>
        LIMIT 50000;
    </select>

    <select id="getPayableMinusMonthlyListByServicePointId" resultType="ServicePointPayableMonthly">
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '1'                     AS MONTH,
                payable.m1              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m1
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '2'                     AS MONTH,
                payable.m2              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m2
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '3'                     AS MONTH,
                payable.m3              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m3
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '4'                     AS MONTH,
                payable.m4              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m4
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '5'                     AS MONTH,
                payable.m5              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m5
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '6'                     AS MONTH,
                payable.m6              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m6
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '7'                     AS MONTH,
                payable.m7              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m7
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '8'                     AS MONTH,
                payable.m8              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m8
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '9'                     AS MONTH,
                payable.m9              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m9
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '10'                    AS MONTH,
                payable.m10             AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m10
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '11'                    AS MONTH,
                payable.m11             AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m11
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '12'                    AS MONTH,
                payable.m12             AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.servicepoint_id = #{servicePointId}
          AND   payable.payment_type = 10
          AND 	0 > payable.m12
    </select>

    <select id="getPayableMinusMonthlyDetailList" resultType="ServicePointPayableMonthlyDetail">
        <foreach collection="details" item="detail" separator=" union ">
            SELECT
                    payable.servicepoint_id AS 'servicePoint.id',
                    `year`,
                    ${detail.month}                 AS MONTH,
                    ${detail.monthField}            AS amount,
                    payable.product_category_id,
                    payable.last_deduction_year_month
            FROM
                    fi_servicepoint_payable_monthly_detail payable
            WHERE
                    total_id = #{detail.totalId}
        </foreach>
    </select>

    <select id="getPayableMinusMonthlyList" resultType="ServicePointPayableMonthly">
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '1'                     AS MONTH,
                payable.m1              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m1
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '2'                     AS MONTH,
                payable.m2              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m2
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '3'                     AS MONTH,
                payable.m3              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m3
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '4'                     AS MONTH,
                payable.m4              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m4
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '5'                     AS MONTH,
                payable.m5              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m5
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '6'                     AS MONTH,
                payable.m6              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m6
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '7'                     AS MONTH,
                payable.m7              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m7
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '8'                     AS MONTH,
                payable.m8              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m8
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '9'                     AS MONTH,
                payable.m9              AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m9
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '10'                    AS MONTH,
                payable.m10             AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m10
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '11'                    AS MONTH,
                payable.m11             AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m11
        UNION
        SELECT
                payable.servicepoint_id AS 'servicePoint.id',
                `year`,
                '12'                    AS MONTH,
                payable.m12             AS amount,
                payable.last_deduction_year_month
        FROM
                fi_servicepoint_payable_monthly payable
        WHERE
                payable.payment_type = 10
          AND 	0 > payable.m12
    </select>

    <!-- 获取网点的结算方式 -->
    <select id="getServicePointPaymentType" resultType="java.lang.Integer">
        SELECT
              payment_type
        FROM  md_servicepoint_finance
        WHERE id  = #{servicePointId}
    </select>

    <!--根据用ID列表获取网点余额-->
    <select id="getBalanceByIds" resultType="ServicePointFinance">
        SELECT
            id,
            balance
        FROM
            md_servicepoint_finance
        <if test="ids != null and ids.size > 0">
            WHERE id IN
            <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
    </select>

    <!-- 更新网点银行账号信息 -->
    <update id="updateServicePointFIBankAccountInfo">
        UPDATE md_servicepoint_finance
        SET
          bank = #{bank.value},
          branch = #{branch},
          bank_no = #{bankNo},
          bank_owner = #{bankOwner}
        WHERE id = #{id}
    </update>

    <select id="findAllServicePointProductCategoryMapping" resultType="LongTwoTuple">
        SELECT
               service_point_id     AS "aElement",
               product_category_id  AS "bElement"
        FROM  md_productcategory_servicepoint
        LIMIT 100000
    </select>

    <!-- 根据ID列表获取网点质保金余额 -->
    <select id="getDepositByIds" resultType="com.wolfking.jeesite.modules.md.entity.ServicePointFinance">
        SELECT
            id,
            deposit,
            deposit_recharge
        FROM
            md_servicepoint_finance
        <if test="ids != null and ids.size > 0">
            WHERE id IN
            <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
    </select>

    <!-- 根据ID从主库获取网点质保金余额 -->
    <select id="getDepositFromMasterById" resultType="com.wolfking.jeesite.modules.md.entity.ServicePointFinance">
        /*!mycat:db_type=master*/
        SELECT
            id,
            deposit,
            deposit_recharge
        FROM
            md_servicepoint_finance
        WHERE id = #{id}
        limit 1
    </select>

    <!-- 质保金充值-->
    <update id="updateDepositWhenRecharge" parameterType="java.util.HashMap">
        UPDATE
            md_servicepoint_finance
        set
                deposit = deposit + #{deposit},
                deposit_recharge = deposit_recharge + #{deposit}
        WHERE
            id = #{id}
        limit 1
    </update>

</mapper>
