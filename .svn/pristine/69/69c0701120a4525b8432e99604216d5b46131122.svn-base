package com.wolfking.jeesite.modules.sd.web;


import com.google.common.collect.Lists;
import com.kkl.kklplus.entity.b2bcenter.md.B2BDataSourceEnum;
import com.kkl.kklplus.entity.md.MDErrorCode;
import com.kkl.kklplus.entity.md.MDErrorType;
import com.kkl.kklplus.entity.md.dto.MDActionCodeDto;
import com.kkl.kklplus.entity.praise.PraiseStatusEnum;
import com.wolfking.jeesite.common.config.redis.RedisConstant;
import com.wolfking.jeesite.common.exception.OrderException;
import com.wolfking.jeesite.common.persistence.AjaxJsonEntity;
import com.wolfking.jeesite.common.persistence.IntegerRange;
import com.wolfking.jeesite.common.persistence.Page;
import com.wolfking.jeesite.common.utils.DateUtils;
import com.wolfking.jeesite.common.utils.RedisUtils;
import com.kkl.kklplus.utils.StringUtils;
import com.wolfking.jeesite.common.web.BaseController;
import com.wolfking.jeesite.modules.md.entity.*;
import com.wolfking.jeesite.modules.md.service.ServicePointService;
import com.wolfking.jeesite.modules.md.service.ServiceTypeService;
import com.wolfking.jeesite.modules.md.service.UrgentLevelService;
import com.wolfking.jeesite.modules.sd.entity.*;
import com.wolfking.jeesite.modules.sd.entity.viewModel.HistoryPlanOrderModel;
import com.wolfking.jeesite.modules.sd.entity.viewModel.OrderSearchModel;
import com.wolfking.jeesite.modules.sd.service.*;
import com.wolfking.jeesite.modules.sd.utils.OrderUtils;
import com.wolfking.jeesite.modules.sys.entity.Area;
import com.wolfking.jeesite.modules.sys.entity.Dict;
import com.wolfking.jeesite.modules.sys.entity.KefuTypeEnum;
import com.wolfking.jeesite.modules.sys.entity.User;
import com.wolfking.jeesite.modules.sys.utils.AreaUtils;
import com.wolfking.jeesite.modules.sys.utils.LogUtils;
import com.wolfking.jeesite.modules.sys.utils.UserUtils;
import com.wolfking.jeesite.ms.providermd.service.*;
import com.wolfking.jeesite.ms.tmall.md.entity.B2bCustomerMap;
import com.wolfking.jeesite.ms.tmall.md.service.B2bCustomerMapService;
import com.wolfking.jeesite.ms.tmall.sd.entity.TmallAnomalyRecourse;
import com.wolfking.jeesite.ms.tmall.sd.entity.TmallServiceMonitor;
import com.wolfking.jeesite.ms.tmall.sd.entity.ViewModel.TmallAnomalyRecourseSearchVM;
import com.wolfking.jeesite.ms.tmall.sd.entity.ViewModel.TmallServiceMonitorSearchVM;
import com.wolfking.jeesite.ms.utils.MSDictUtils;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections.CollectionUtils;
import org.apache.shiro.authz.annotation.Logical;
import org.apache.shiro.authz.annotation.RequiresPermissions;
import org.apache.shiro.authz.annotation.RequiresUser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.util.ObjectUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.UnsupportedEncodingException;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;


/**
 * @author Ryan
 * 陈明彬确定，客服总监也按区域筛选订单，不做特殊判断和处理
 * @version 1.1
 * @date 2018/09/18
 * @version 1.2
 * @date 2019/09/12
 * 使用新的日期选择控件，以控制时间范围最大不能超过365天
 * @version 1.3
 * @date 2019/09/14
 * 还原日期选择控件，增加判断来控制最大范围
 * @version 1.4
 * @date 2019/12/10
 * 增加店铺选择及查询
 * @version 1.5
 * @date 2019/12/11
 * 客服增加vip客服(sub_flag=1),只查看自己负责的客户(vip客户)(sys_user_customer)+设定区域的订单(sd_order_condition.customer_type=1)
 * sub_flag=0,为超级客服，查询设定的区域订单(包含vip客户及非vip客户的订单)
 * sub_flag=2,为普通客服，查询非vip客户且设定的区域定(sd_order_condition.customer_type=0)
 *
 * @version 1.6
 * @date 2020/05/14
 * 客服增加突击客服(sub_flag=3),只查看orderCondition.can_rush=1的单；
 * 普通客服，不能查看can_rush=1的单
 * 突击的区域，下单时，才将orderCondition.can_rush设定为1
 */
@Controller
@RequestMapping(value = "${adminPath}/sd/order/kefuOrderList/")
@Slf4j
public class KefuOrderListController extends BaseController {

    private static final int DEFAULT_PAGE_SIZE = 12;

    @Autowired
    private KefuOrderListService kefuOrderListService;

    @Autowired
    private UrgentLevelService urgentLevelService;

    @Autowired
    private OrderService orderService;

    @Autowired
    private ServicePointService servicePointService;

    @Autowired
    private RedisUtils redisUtils;

    @Autowired
    private OrderVoiceTaskService orderVoiceTaskService;

    @Autowired
    private OrderAuxiliaryMaterialService orderAuxiliaryMaterialService;

	@Autowired
    private MSErrorTypeService msErrorTypeService;
    @Autowired
    private MSErrorCodeService msErrorCodeService;
    @Autowired
    private MSActionCodeService msActionCodeService;
    @Autowired
    private ServiceTypeService serviceTypeService;
    @Autowired
    private B2bCustomerMapService b2bCustomerMapService;
    @Autowired
    private OrderStatusFlagService orderStatusFlagService;
    @Autowired
    private MSCustomerProductService msCustomerProductService;
    @Autowired
    private MSRegionPermissionService msRegionPermissionService;

    private static final String MODEL_ATTR_PAGE = "page";
    private static final String MODEL_ATTR_ORDER = "order";

    private static final String VIEW_NAME_PLANNING_LIST = "modules/sd/kefuOrderList/planingList";
    private static final String VIEW_NAME_NOAPPOINTMENT_LIST = "modules/sd/kefuOrderList/noAppointmentList";
    private static final String VIEW_NAME_ARRIVEAPPOINTMENT_LIST = "modules/sd/kefuOrderList/arriveAppointmentList";
    private static final String VIEW_NAME_PASSAPPOINTMENT_LIST = "modules/sd/kefuOrderList/passAppointmentList";
    private static final String VIEW_NAME_PENDING_LIST = "modules/sd/kefuOrderList/pendingList";
    private static final String VIEW_NAME_SERVICED_LIST = "modules/sd/kefuOrderList/servicedList";
    private static final String VIEW_NAME_FOLLOWUP_FAIL_LIST = "modules/sd/kefuOrderList/followUpFailList";
    private static final String VIEW_NAME_UMCOMPLETED_LIST = "modules/sd/kefuOrderList/uncompletedList";
    private static final String VIEW_NAME_ALL_LIST = "modules/sd/kefuOrderList/allList";
    private static final String VIEW_NAME_COMPLETED_LIST = "modules/sd/kefuOrderList/completedList";
    private static final String VIEW_NAME_REMINDER_LIST = "modules/sd/kefuOrderList/reminderList";

    private static final String VIEW_NAME_TMALLANOMALY_LIST = "modules/sd/kefuOrderList/tmallAnomalyList";
    private static final String VIEW_NAME_TMALLSERVICEMONITOR_LIST = "modules/sd/kefuOrderList/tmallServiceMonitorList";
    private static final String VIEW_NAME_RUSHING_LIST = "modules/sd/kefuOrderList/rushingList";
    private static final String VIEW_NAME_COMPLAIN_LIST = "modules/sd/kefuOrderList/complainList";

    /**
     * 设置必须的查询条件
     * @param user  当前帐号
     * @param searchModel   查询条件
     * @param initMonths    初始最小查询时间段(月)
     * @param searchByOrderDateRange by下单日期查询开关
     * @param maxOrderDays   下单最大查询范围(天)
     * @param searchByCompleteDateRange by完成日期查询开关
     * @param maxCompleteDays 完成最大查询范围(天)
     */
    private OrderSearchModel setSearchModel(User user,OrderSearchModel searchModel,Model model ,
                                            int initMonths,boolean searchByOrderDateRange ,int maxOrderDays,
                                            boolean searchByCompleteDateRange,int maxCompleteDays) {
        if (searchModel == null) {
            searchModel = new OrderSearchModel();
        }
        Area area = searchModel.getArea();
        if(area == null){
            area = new Area(0L);
            searchModel.setArea(area);
        }
        if(area.getParent()==null || area.getParent().getId() == null){
            area.setParent(new Area(0L));
        }
        String checkRegion = kefuOrderListService.loadAndCheckUserRegions(searchModel,user);
        if(StringUtils.isNotEmpty(checkRegion)){
            addMessage(model, checkRegion);
            searchModel.setValid(false);
            return searchModel;
        }
        //客服主管
        boolean isServiceSupervisor = user.getRoleEnNames().contains("Customer service supervisor");
        if (searchModel.getStatus() == null || StringUtils.isBlank(searchModel.getStatus().getValue())) {
            searchModel.setStatus(null);
        }

        Date now = new Date();
        //下单日期
        if(searchByOrderDateRange) {
            if (searchModel.getBeginDate() == null) {
                searchModel.setEndDate(DateUtils.getDateEnd(new Date()));
                searchModel.setBeginDate(DateUtils.getStartDayOfMonth(DateUtils.addMonth(new Date(), 0 - initMonths)));
            } else {
                searchModel.setEndDate(DateUtils.getDateEnd(searchModel.getEndDate()));
            }
            //检查最大时间范围
            if(maxOrderDays > 0) {
                Date maxDate = DateUtils.addDays(searchModel.getEndDate(), 0 - maxOrderDays);
                maxDate = DateUtils.getDateStart(maxDate);
                if (DateUtils.pastDays(searchModel.getBeginDate(), maxDate) > 0) {
                    searchModel.setBeginDate(maxDate);
                }
            }
        }
        //完成日期
        if(searchByCompleteDateRange){
            if (searchModel.getCompleteEnd() != null) {
                searchModel.setCompleteEnd(DateUtils.getDateEnd(searchModel.getCompleteEnd()));
            }
            //检查最大时间范围
            if(maxCompleteDays > 0 && searchModel.getCompleteBegin() != null){
                Date maxDate = DateUtils.addDays(searchModel.getCompleteBegin(),maxCompleteDays-1);
                maxDate = DateUtils.getDateEnd(maxDate);
                if(searchModel.getCompleteEnd() == null){
                    searchModel.setCompleteEnd(DateUtils.getDateEnd(now));
                }
                if(DateUtils.pastDays(maxDate,searchModel.getCompleteEnd())>0){
                    searchModel.setCompleteEnd(maxDate);
                }
            }
        }
        //int subQueryUserArea = 1;
        //vip客服查询自己负责的单，by客户+区域+品类
        //1.by 客户，前端客户已按客服筛选了
        if(user.isKefu()) {
            if (user.getSubFlag() == KefuTypeEnum.VIPKefu.getCode()) {
                //vip客服查询自己负责的单，by客户+区域+品类
                searchModel.setCustomerType(1);//指派客户，关联sys_user_customer
                searchModel.setRushType(null);//忽略突击区域
            } else if (user.getSubFlag() == KefuTypeEnum.Kefu.getCode()) {
                //普通客服
                searchModel.setCustomerType(0);//不能查询vip客户订单
                searchModel.setRushType(0);//不能查看突击区域订单
            } else if (user.getSubFlag() == KefuTypeEnum.Rush.getCode()){
                //突击客服，只看自己负责的单
                searchModel.setCustomerType(0);//不能查询vip客户订单
                searchModel.setRushType(1);//查看突击区域订单
            }else {
                //超级客服，查询所有客户订单，包含Vip客户
                searchModel.setCustomerType(null); //可查看Vip客户订单
                searchModel.setRushType(null);//可查看突击区域订单
            }
        }else{
            //其他类型帐号，不限制客户及突击区域订单
            searchModel.setCustomerType(null);
            searchModel.setRushType(null);
        }
        //2.by 区域
        if (isServiceSupervisor) {
            searchModel.setCreateBy(user);//*
        } else if (user.isKefu()) {
            searchModel.setCreateBy(user);//*,只有客服才按帐号筛选
        } else if (user.isInnerAccount()) { //内部帐号
            searchModel.setCreateBy(user);//*
        }
        loadB2BShops(searchModel);
        return searchModel;
    }

    /**
     * 检查订单号，手机号输入
     * @param searchModel
     * @param model
     * @return
     */
    private Boolean checkOrderNoAndPhone(OrderSearchModel searchModel,Model model,Page<Order> page){
        if(searchModel == null){
            return true;
        }
        //检查电话
        int orderSerchType = searchModel.getOrderNoSearchType();
        if (StringUtils.isNotBlank(searchModel.getOrderNo())){
            if(orderSerchType != 1) {
                addMessage(model, "错误：请输入正确的订单号码");
                model.addAttribute(MODEL_ATTR_PAGE, page);
                model.addAttribute(MODEL_ATTR_ORDER, searchModel);
                return false;
            }else{
                //检查分片
                try {
                    Date goLiveDate = OrderUtils.getGoLiveDate();
                    String[] quarters = DateUtils.getQuarterRange(goLiveDate, new Date());
                    if(quarters.length == 2) {
                        int start = StringUtils.toInteger(quarters[0]);
                        int end = StringUtils.toInteger(quarters[1]);
                        if(start>0 && end > 0){
                            int quarter = StringUtils.toInteger(searchModel.getQuarter());
                            if(quarter < start || quarter > end){
                                addMessage(model, "错误：请输入正确的订单号码");
                                model.addAttribute(MODEL_ATTR_PAGE, page);
                                model.addAttribute(MODEL_ATTR_ORDER, searchModel);
                                return false;
                            }
                        }
                    }
                }catch (Exception e){
                    log.error("检查分片错误,orderNo:{}",searchModel.getOrderNo(),e);
                }
            }
        }
        if (StringUtils.isNotBlank(searchModel.getPhone1())){
            if(searchModel.getIsPhone() != 1){
                addMessage(model, "错误：请输入正确的用户电话");
                model.addAttribute(MODEL_ATTR_PAGE, page);
                model.addAttribute(MODEL_ATTR_ORDER, searchModel);
                return false;
            }
        }
        return true;
    }

    /**
     * 按客户+数据源装载店铺列表
     */
    private void loadB2BShops(OrderSearchModel searchModel){
        //b2b
        if (searchModel.getCustomer() != null && searchModel.getCustomer().getId() != null && searchModel.getCustomer().getId() > 0
                && searchModel.getDataSource() >0 && B2BDataSourceEnum.isDataSource(searchModel.getDataSource())) {
            List<B2bCustomerMap> shopList = b2bCustomerMapService.getShopListByCustomerNew(searchModel.getDataSource(), searchModel.getCustomer().getId());
            searchModel.setShopList(shopList);
        }
    }

    /**
     * 装载加急等级列表
     */
    private void loadUrgentLevels(OrderSearchModel searchModel){
        List<UrgentLevel> urgentLevels = urgentLevelService.findAllList();
        searchModel.setUrgentLevels(urgentLevels);
    }

    //region 普通列表

    /**
     * 待接单/待派单
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "planinglist")
    public String planingList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_PLANNING_LIST;
        }
        try {
            page = kefuOrderListService.findKefuPlaningOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);
        return VIEW_NAME_PLANNING_LIST;
    }

    /**
     * 未预约
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "noAppointmentList")
    public String noAppointmentList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_NOAPPOINTMENT_LIST;
        }
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuNoAppointmentOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,未预约列表,未回复反馈搜索查询","kefuNoAppointmentList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,未预约列表,反馈内容搜索查询","kefuNoAppointmentList",user);
        }

        return VIEW_NAME_NOAPPOINTMENT_LIST;

    }

    /**
     * 预约到期
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "arriveAppointmentList")
    public String arriveAppointmentList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_ARRIVEAPPOINTMENT_LIST;
        }
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuArriveAppointmentOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,预约到期列表,未回复反馈搜索查询","kefuArriveAppointmentList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,预约到期列表,反馈内容搜索查询","kefuArriveAppointmentList",user);
        }

        return VIEW_NAME_ARRIVEAPPOINTMENT_LIST;

    }

    /**
     * 预约超期
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "passAppointmentList")
    public String passAppointmentList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_PASSAPPOINTMENT_LIST;
        }
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuPassAppointmentOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,预约超期列表,未回复反馈搜索查询","kefuPassAppointmentList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,预约超期列表,反馈内容搜索查询","kefuPassAppointmentList",user);
        }

        return VIEW_NAME_PASSAPPOINTMENT_LIST;

    }

    /**
     * 停滞工单
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:service",
                    "sd:order:complete", "sd:order:return", "sd:order:grade",
                    "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "pendinglist")
    public String pendinglist(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,true,365);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_PENDING_LIST;
        }
        try {
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuPendingOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,停滞列表,未回复反馈搜索查询","kefuPendinglist",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,停滞列表,反馈内容搜索查询","kefuPendinglist",user);
        }

        return VIEW_NAME_PENDING_LIST;
    }

    /**
     * 待回访
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "servicedList")
    public String servicedList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_SERVICED_LIST;
        }
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuServicedOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,待回访列表,未回复反馈搜索查询","kefuServicedList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,待回访列表,反馈内容搜索查询","kefuServicedList",user);
        }

        return VIEW_NAME_SERVICED_LIST;

    }

    /**
     * 回访失败列表
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "followUpFailList")
    public String followUpFailList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_FOLLOWUP_FAIL_LIST;
        }
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuFollowUpFailOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,回访失败列表,未回复反馈搜索查询","kefuFollowUpFailList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,回访失败列表,反馈内容搜索查询","kefuFollowUpFailList",user);
        }

        return VIEW_NAME_FOLLOWUP_FAIL_LIST;

    }

    /**
     * 未完成
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "uncompletedList")
    public String uncompletedList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_UMCOMPLETED_LIST;
        }
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuUncompletedOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,未完成列表,未回复反馈搜索查询","kefuUncompletedList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,未完成列表,反馈内容搜索查询","kefuUncompletedList",user);
        }

        return VIEW_NAME_UMCOMPLETED_LIST;
    }


    /**
     * 所有
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:service",
                    "sd:order:complete", "sd:order:return", "sd:order:grade",
                    "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "alllist")
    public String allList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        String viewForm = VIEW_NAME_ALL_LIST;
        if (user == null || user.getId() == null) {
            addMessage(model, "错误：登录超时，请退出后重新登录。");
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return viewForm;
        }
        String messageType = request.getParameter("messageType");
        String appAbnormalyFlag = request.getParameter("appAbnormalyFlag");
        Boolean findNoticeMessage = false;
        if (StringUtils.isNoneBlank(messageType) && StringUtils.isNumeric(messageType)) {
            findNoticeMessage = true;
            order.setMessageType(Integer.valueOf(messageType));
        } else {
            order.setMessageType(null);
        }
        if (StringUtils.isNoneBlank(appAbnormalyFlag) && StringUtils.isNumeric(appAbnormalyFlag)) {
            findNoticeMessage = true;
            order.setAppAbnormalyFlag(Integer.valueOf(appAbnormalyFlag));
        } else {
            order.setAppAbnormalyFlag(null);
        }
        //因界面需要，对area.parent初始化
        if(order.getArea() == null || order.getArea().getId() == null){
            order.setArea(new Area(0L));
            order.setAreaLevel(null);
        }
        //提交查询
        if (request.getMethod().equalsIgnoreCase("post") || findNoticeMessage) {
            order = setSearchModel(user,order,model,3,true,365,true,365);
            if(!order.getValid()){
                model.addAttribute(MODEL_ATTR_PAGE, page);
                model.addAttribute(MODEL_ATTR_ORDER, order);
                return VIEW_NAME_PLANNING_LIST;
            }
            Boolean isValide = checkOrderNoAndPhone(order,model,page);
            if(!isValide){
                return viewForm;
            }
            try {
                page = kefuOrderListService.findKefuAllOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
            } catch (Exception e) {
                addMessage(model, "错误：" + e.getMessage());
            }
        } else {
            //访问页面，未查询
            order.setEndDate(new Date());
            order.setBeginDate(DateUtils.getStartDayOfMonth(DateUtils.addMonth(new Date(), -3)));
        }
        loadUrgentLevels(order);
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,所有列表,未回复反馈搜索查询","kefuAllList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,所有列表,反馈内容搜索查询","kefuAllList",user);
        }


        return viewForm;
    }

    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:service",
                    "sd:order:complete", "sd:order:return", "sd:order:grade",
                    "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "completedList")
    public String completedList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        String viewForm = VIEW_NAME_COMPLETED_LIST;
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        if (user == null || user.getId() == null) {
            addMessage(model, "错误：登录超时，请退出后重新登录。");
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return viewForm;
        }

        //提交查询
        if (request.getMethod().equalsIgnoreCase("post")) {
            order = setSearchModel(user,order,model,3,true,365,true,365);
            if(!order.getValid()){
                model.addAttribute(MODEL_ATTR_PAGE, page);
                model.addAttribute(MODEL_ATTR_ORDER, order);
                return VIEW_NAME_PLANNING_LIST;
            }
            Boolean isValide = checkOrderNoAndPhone(order,model,page);
            if(!isValide){
                return viewForm;
            }
            try {
                page = kefuOrderListService.findKefuCompletedOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
            } catch (Exception e) {
                addMessage(model, "错误：" + e.getMessage());
            }
        } else {
            //访问页面，未查询
            order.setEndDate(new Date());
            order.setBeginDate(DateUtils.getStartDayOfMonth(DateUtils.addMonth(new Date(), -3)));
        }
        //加急
        loadUrgentLevels(order);
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);

        //记录反馈，反馈内容条件搜索频率情况
        if(order.getReplyFlagCustomer()==2){
            LogUtils.saveLog(request,null,null,"客服工单,已完成列表,未回复反馈搜索查询","kefuCompletedList",user);
        }
        if(StringUtils.isNotBlank(order.getRemarks())){
            LogUtils.saveLog(request,null,null,"客服工单,已完成列表,反馈内容搜索查询","kefuCompletedList",user);
        }

        return viewForm;
    }

    //endregion 普通列表

    //region 特殊列表

    /**
     * 天猫请求
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete", "sd:order:anomaly",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "tmallAnomalyList")
    public String tmallAnomalyList(TmallAnomalyRecourseSearchVM searchEntity, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<TmallAnomalyRecourse> page = new Page<>();
        User user = UserUtils.getUser();
        //检查订单号码
        if(StringUtils.isNotBlank(searchEntity.getOrderNo())) {
            int orderSerchType = searchEntity.getOrderNoSearchType();
            if (orderSerchType != 1) {
                addMessage(model, "错误：请输入正确的订单号码");
                model.addAttribute("page", page);
                model.addAttribute("searchEntity", searchEntity);
                return VIEW_NAME_TMALLANOMALY_LIST;
            } else {
                //检查分片
                try {
                    Date goLiveDate = OrderUtils.getGoLiveDate();
                    String[] quarters = DateUtils.getQuarterRange(goLiveDate, new Date());
                    if (quarters.length == 2) {
                        int start = StringUtils.toInteger(quarters[0]);
                        int end = StringUtils.toInteger(quarters[1]);
                        if (start > 0 && end > 0) {
                            int quarter = StringUtils.toInteger(searchEntity.getQuarter());
                            if (quarter < start || quarter > end) {
                                quarters = null;
                                goLiveDate = null;
                                addMessage(model, "错误：请输入正确的订单号码");
                                model.addAttribute("page", page);
                                model.addAttribute("searchEntity", searchEntity);
                                return VIEW_NAME_TMALLANOMALY_LIST;
                            }
                        }
                    }
                } catch (Exception e) {
                    log.error("检查分片错误,orderNo:{}", searchEntity.getOrderNo(), e);
                }
            }
        }
        //date
        Date now = new Date();
        if (searchEntity.getSubmitStartDate() == null) {
            searchEntity.setSubmitEndDate(DateUtils.getDateEnd(now));
            searchEntity.setSubmitStartDate(DateUtils.getStartDayOfMonth(DateUtils.addMonth(now, -3)));
        } else {
            searchEntity.setSubmitEndDate(DateUtils.getDateEnd(searchEntity.getSubmitEndDate()));
        }
        String checkRegion = kefuOrderListService.loadAndCheckUserRegions(searchEntity,user);
        if(StringUtils.isNotEmpty(checkRegion)){
            addMessage(model, checkRegion);
            model.addAttribute("page", page);
            model.addAttribute("searchEntity", searchEntity);
            return VIEW_NAME_TMALLANOMALY_LIST;
        }
        //客服主管
        boolean isServiceSupervisor = user.getRoleEnNames().contains("Customer service supervisor");
       /* if (isServiceSupervisor) {
            searchEntity.setSubQueryUserArea(1);
            searchEntity.setKefu(user.getId());//*
        } else if (user.isKefu()) {
            searchEntity.setSubQueryUserArea(1);
            searchEntity.setKefu(user.getId());//*,只有客服才按帐号筛选
        } else if (user.isInnerAccount()) { //内部帐号
            searchEntity.setSubQueryUserArea(1);
            searchEntity.setKefu(user.getId());//*
        } else {
            searchEntity.setSubQueryUserArea(0);//非客服可查询任何区域
        }*/
        //vip客服查询自己负责的单，by客户+区域+品类
        //1.by 客户，前端客户已按客服筛选了
        if(user.isKefu()) {
            if (user.getSubFlag() == KefuTypeEnum.VIPKefu.getCode()) {
                //vip客服查询自己负责的单，by客户+区域+品类
                searchEntity.setCustomerType(1);//指派客户，关联sys_user_customer
                searchEntity.setRushType(null);//忽略突击区域
            } else if (user.getSubFlag() == KefuTypeEnum.Kefu.getCode()) {
                //普通客服
                searchEntity.setCustomerType(0);//不能查询vip客户订单
                searchEntity.setRushType(0);//不能查看突击区域订单
            } else if (user.getSubFlag() == KefuTypeEnum.Rush.getCode()){
                //突击客服，只看自己负责的单
                searchEntity.setCustomerType(0);//不能查询vip客户订单
                searchEntity.setRushType(1);//查看突击区域订单
            }else {
                //超级客服，查询所有客户订单，包含Vip客户
                searchEntity.setCustomerType(null); //可查看Vip客户订单
                searchEntity.setRushType(null);//可查看突击区域订单
            }
        }else{
            //其他类型帐号，不限制客户及突击区域订单
            searchEntity.setCustomerType(null);
            searchEntity.setRushType(null);
        }
        //2.by 区域
        if (isServiceSupervisor) {
            searchEntity.setCreateBy(user);//*
        } else if (user.isKefu()) {
            searchEntity.setCreateBy(user);//*,只有客服才按帐号筛选
        } else if (user.isInnerAccount()) { //内部帐号
            searchEntity.setCreateBy(user);//*
        }
        try {
            //查询
            page = kefuOrderListService.findKefuTmallAnomalyList(new Page<>(request, response, DEFAULT_PAGE_SIZE), searchEntity);
        } catch (Exception e) {
            log.error("[AnomalyRecourseController.list] ", e);
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute("page", page);
        model.addAttribute("searchEntity", searchEntity);
        return VIEW_NAME_TMALLANOMALY_LIST;
    }

    /**
     * 天猫预警
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:service",
                    "sd:order:complete", "sd:order:return", "sd:order:grade",
                    "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = {"tmallServiceMonitorList"})
    public String tmallServiceMonitorList(TmallServiceMonitorSearchVM tmallServiceMonitor, HttpServletRequest request, HttpServletResponse response, Model model) {
        if (tmallServiceMonitor.getStatus() == null || tmallServiceMonitor.getStatus() < 0) {
            tmallServiceMonitor.setStatus(1);
        }
        Page<TmallServiceMonitor> page = new Page<>();
        User user = UserUtils.getUser();
        //检查订单号码
        if(StringUtils.isNotBlank(tmallServiceMonitor.getOrderNo())) {
            int orderSerchType = tmallServiceMonitor.getOrderNoSearchType();
            if (orderSerchType != 1) {
                addMessage(model, "错误：订单号码输入无效");
                model.addAttribute(MODEL_ATTR_PAGE, page);
                model.addAttribute("entity", tmallServiceMonitor);
                return VIEW_NAME_TMALLSERVICEMONITOR_LIST;
            } else {
                //检查分片
                try {
                    Date goLiveDate = OrderUtils.getGoLiveDate();
                    String[] quarters = DateUtils.getQuarterRange(goLiveDate, new Date());
                    if (quarters.length == 2) {
                        int start = StringUtils.toInteger(quarters[0]);
                        int end = StringUtils.toInteger(quarters[1]);
                        if (start > 0 && end > 0) {
                            int quarter = StringUtils.toInteger(tmallServiceMonitor.getQuarter());
                            if (quarter < start || quarter > end) {
                                quarters = null;
                                goLiveDate = null;
                                addMessage(model, "错误：订单号码输入无效");
                                model.addAttribute(MODEL_ATTR_PAGE, page);
                                model.addAttribute("entity", tmallServiceMonitor);
                                return VIEW_NAME_TMALLSERVICEMONITOR_LIST;
                            }
                        }
                    }
                } catch (Exception e) {
                    log.error("检查分片错误,orderNo:{}", tmallServiceMonitor.getOrderNo(), e);
                }
            }
        }
        String checkRegion = kefuOrderListService.loadAndCheckUserRegions(tmallServiceMonitor,user);
        if(StringUtils.isNotEmpty(checkRegion)){
            addMessage(model, checkRegion);
            model.addAttribute("page", page);
            model.addAttribute("entity", tmallServiceMonitor);
            return VIEW_NAME_TMALLSERVICEMONITOR_LIST;
        }
        //客服主管
        boolean isServiceSupervisor = user.getRoleEnNames().contains("Customer service supervisor");
        /*if (isServiceSupervisor) {
            tmallServiceMonitor.setSubQueryUserArea(1);
            tmallServiceMonitor.setKefu(user.getId());//*
        } else if (user.isKefu()) {
            tmallServiceMonitor.setSubQueryUserArea(1);
            tmallServiceMonitor.setKefu(user.getId());//*,只有客服才按帐号筛选
        } else if (user.isInnerAccount()) { //内部帐号
            tmallServiceMonitor.setSubQueryUserArea(1);
            tmallServiceMonitor.setKefu(user.getId());//*
        } else {
            tmallServiceMonitor.setSubQueryUserArea(0);//非客服可查询任何区域
        }*/
        //vip客服查询自己负责的单，by客户+区域+品类
        //1.by 客户，前端客户已按客服筛选了
        if(user.isKefu()) {
            if (user.getSubFlag() == KefuTypeEnum.VIPKefu.getCode()) {
                //vip客服查询自己负责的单，by客户+区域+品类
                tmallServiceMonitor.setCustomerType(1);//指派客户，关联sys_user_customer
                tmallServiceMonitor.setRushType(null);//忽略突击区域
            } else if (user.getSubFlag() == KefuTypeEnum.Kefu.getCode()) {
                //普通客服
                tmallServiceMonitor.setCustomerType(0);//不能查询vip客户订单
                tmallServiceMonitor.setRushType(0);//不能查看突击区域订单
            } else if (user.getSubFlag() == KefuTypeEnum.Rush.getCode()){
                //突击客服，只看自己负责的单
                tmallServiceMonitor.setCustomerType(0);//不能查询vip客户订单
                tmallServiceMonitor.setRushType(1);//查看突击区域订单
            }else {
                //超级客服，查询所有客户订单，包含Vip客户
                tmallServiceMonitor.setCustomerType(null); //可查看Vip客户订单
                tmallServiceMonitor.setRushType(null);//可查看突击区域订单
            }
        }else{
            //其他类型帐号，不限制客户及突击区域订单
            tmallServiceMonitor.setCustomerType(null);
            tmallServiceMonitor.setRushType(null);
        }
        //2.by 区域
        if (isServiceSupervisor) {
            tmallServiceMonitor.setCreateBy(user);//*
        } else if (user.isKefu()) {
            tmallServiceMonitor.setCreateBy(user);//*,只有客服才按帐号筛选
        } else if (user.isInnerAccount()) { //内部帐号
            tmallServiceMonitor.setCreateBy(user);//*
        }
        page = kefuOrderListService.findKefuTmallServiceMonitorList(new Page<>(request, response, DEFAULT_PAGE_SIZE), tmallServiceMonitor);
        model.addAttribute("entity", tmallServiceMonitor);
        model.addAttribute(MODEL_ATTR_PAGE, page);
        return VIEW_NAME_TMALLSERVICEMONITOR_LIST;
    }

    /**
     * 突击列表
     * 突击未完成或未提交
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "rushinglist")
    public String rushingList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        //状态：所有
        if (order.getStatus() == null || StringUtils.isBlank(order.getStatus().getValue())) {
            order.setStatus(null);
            order.setStatusRange(new IntegerRange(Order.ORDER_STATUS_APPROVED, Order.ORDER_STATUS_ACCEPTED));//待接单，已接单
        }
        order = setSearchModel(user,order,model,1,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_RUSHING_LIST;
        }
        //客服主管
        order.setOrderDataLevel(OrderUtils.OrderDataLevel.DETAIL);//从数据库/redis中读取具体的数据内容
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuRushingOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);
        return VIEW_NAME_RUSHING_LIST;
    }

    /**
     * 投诉列表
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "complainlist")
    public String complainList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page<Order> page = new Page<>();
        User user = UserUtils.getUser();
        //状态：所有
        if (order.getStatus() == null || StringUtils.isBlank(order.getStatus().getValue())) {
            order.setStatus(null);
            order.setStatusRange(new IntegerRange(Order.ORDER_STATUS_APPROVED, Order.ORDER_STATUS_ACCEPTED));//待接单，已接单
        }
        order = setSearchModel(user,order,model,1,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_COMPLAIN_LIST;
        }
        order.setOrderDataLevel(OrderUtils.OrderDataLevel.DETAIL);//从数据库/redis中读取具体的数据内容
        try {
            //加急
            loadUrgentLevels(order);
            page = kefuOrderListService.findKefuComplainOrderList(new Page<>(request, response, DEFAULT_PAGE_SIZE), order, true);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }
        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);
        return VIEW_NAME_COMPLAIN_LIST;
    }

    /**
     * 催单列表
     */
    @RequiresPermissions(value =
            {"sd:order:accept", "sd:order:plan", "sd:order:complete",
                    "sd:order:return", "sd:order:grade", "sd:order:feedback"}, logical = Logical.OR)
    @RequestMapping(value = "reminderlist")
    public String reminderList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        Page page = new Page<>();
        User user = UserUtils.getUser();
        order = setSearchModel(user,order,model,3,true,365,false,0);
        if(!order.getValid()){
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return VIEW_NAME_PLANNING_LIST;
        }
        Boolean isValide = checkOrderNoAndPhone(order,model,page);
        if(!isValide){
            return VIEW_NAME_REMINDER_LIST;
        }
        try {
            order.setOrderNo(order.getOrderNo().trim());
            order.setUserName(order.getUserName().trim());
            order.setPhone1(order.getPhone1().trim());
            order.setAddress(order.getAddress().trim());
            order.setCreator(order.getCreator().trim());
            order.setRemarks(order.getRemarks().trim());
            page = kefuOrderListService.findReminderOrderLit(new Page<OrderSearchModel>(request, response, DEFAULT_PAGE_SIZE), order,true);
            //加急
            loadUrgentLevels(order);
        } catch (Exception e) {
            addMessage(model, "错误：" + e.getMessage());
        }

        model.addAttribute(MODEL_ATTR_PAGE, page);
        model.addAttribute(MODEL_ATTR_ORDER, order);
        return VIEW_NAME_REMINDER_LIST;
    }

    /**
     * 历史派单列表(for客服)
     */
    @RequiresUser
    @RequestMapping(value = "historyPlanList")
    public String historyPlanList(OrderSearchModel order, HttpServletRequest request, HttpServletResponse response, Model model) {
        String viewForm = "modules/sd/kefuOrderList/service/historyPlanOrderList";
        Page<HistoryPlanOrderModel> page = new Page<>(request, response);
        Area area = order.getArea();
        if(area == null || area.getId() == null || area.getId() <= 0){
            addMessage(model, "参数错误：无区域");
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return viewForm;
        }
        User user = UserUtils.getUser();
        page.setPageSize(20);
        String checkRegion = kefuOrderListService.loadAndCheckUserRegions(order,user);
        if(org.apache.commons.lang3.StringUtils.isNotEmpty(checkRegion)){
            addMessage(model, checkRegion);
            model.addAttribute(MODEL_ATTR_PAGE, page);
            model.addAttribute(MODEL_ATTR_ORDER, order);
            return viewForm;
        }

        //date
        if (order.getBeginDate() == null) {
            order.setBeginDate(DateUtils.getStartDayOfMonth(DateUtils.addMonth(new Date(), -3)));
        }
        //完成日期
        if (order.getEndDate() == null) {
            order.setEndDate(DateUtils.getDateEnd(new Date()));
        } else {
            order.setEndDate(DateUtils.getDateEnd(order.getEndDate()));
        }
        boolean isServiceSupervisor = user.getRoleEnNames().contains("Customer service supervisor");
        if (isServiceSupervisor) {
            order.setCreateBy(user);//*
        } else if (user.isKefu()) {
            order.setCreateBy(user);//*客服按帐号筛选
        } else if (user.isInnerAccount()) { //内部帐号
            order.setCreateBy(user);//*
        }
        page = kefuOrderListService.getHistoryPlanListForKefu(page, order);
        model.addAttribute("page", page);
        model.addAttribute("order", order);
        return viewForm;
    }

    //endregion 特殊列表

    //region 客服操作

    private static final String VIEW_NAME_NEW_ORDERDETAIL_INFO_KEFU_FORM = "modules/sd/kefuOrderList/service/newOrderDefailInfoKefuForm";
    private static final String VIEW_NAME_ORDER_PENDINGTYPE_FORM = "modules/sd/service/orderPendingTypeForm";

    private static final String VIEW_NAME_ORDER_FOLLOWUP_DETAIL_FORM = "modules/sd/kefuOrderList/service/orderDefailInfoFollowUpForm";
    private static final String VIEW_NAME_ORDER_FOLLOWUP_FAIL_FORM = "modules/sd/kefuOrderList/service/followUpFailForm";
    private static final String VIEW_NAME_ORDER_FOLLOWUP_ADD_SERVICE_FORM = "modules/sd/kefuOrderList/service/addFollowUpServiceItemForm";
    private static final String VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM = "modules/sd/kefuOrderList/service/editFollowUpServiceItemForm";

    //region 订单详情页

    /**
     * 查看订单明细(客服)
     *
     * @param id 订单id
     * @return
     */
    @RequestMapping(value = {"service/orderDetailInfo"})
    public String kefuOrderDetailInfo(@RequestParam String id, @RequestParam String quarter, String refreshParent, Model model,
                                      HttpServletRequest request) {
        Boolean errorFlag = false;
        Order order = new Order();
        Long orderId = StringUtils.toLong(id);
        boolean hasAuxiliaryMaterils = false;
        if (orderId <= 0) {
            errorFlag = true;
            addMessage(model, "订单代码传递错误");
            model.addAttribute(MODEL_ATTR_ORDER, order);
            model.addAttribute("hasAuxiliaryMaterils",  0);
            model.addAttribute("errorFlag", errorFlag);
            model.addAttribute("fourServicePhone", "400-666-3653");
            model.addAttribute("changed","false");
            return VIEW_NAME_NEW_ORDERDETAIL_INFO_KEFU_FORM;
        } else {
            order = orderService.getOrderById(orderId, quarter, OrderUtils.OrderDataLevel.DETAIL, true);
            if (order == null || order.getOrderCondition() == null) {
                errorFlag = true;
                addMessage(model, "错误：系统繁忙，读取订单失败，请重试。");
                model.addAttribute(MODEL_ATTR_ORDER, order);
                model.addAttribute("hasAuxiliaryMaterils",  0);
                model.addAttribute("errorFlag", errorFlag);
                model.addAttribute("fourServicePhone", "400-666-3653");
                model.addAttribute("changed","false");
                return VIEW_NAME_NEW_ORDERDETAIL_INFO_KEFU_FORM;
            } else {
                if (order.getOrderCondition().getServicePoint() != null && order.getOrderCondition().getServicePoint().getId() != null
                        && order.getOrderCondition().getServicePoint().getId() > 0
                        && order.getOrderCondition().getEngineer() != null && order.getOrderCondition().getEngineer().getId() != null
                        && order.getOrderCondition().getEngineer().getId() > 0) {
                    ServicePoint servicePoint = servicePointService.getFromCache(order.getOrderCondition().getServicePoint().getId());
                    Engineer engineer = servicePointService.getEngineerFromCache(order.getOrderCondition().getServicePoint().getId(), order.getOrderCondition().getEngineer().getId());
                    if (engineer != null) {
                        User engineerUser = new User(engineer.getId());
                        engineerUser.setName(engineer.getName());
                        engineerUser.setMobile(engineer.getContactInfo());
                        engineerUser.setSubFlag(engineer.getMasterFlag() == 1 ? 0 : 1);
//                        engineerUser.setAppLoged(engineer.getAppLoged());
//                        int appLoged = servicePoint !=null && servicePoint.getPrimary()!=null && servicePoint.getPrimary().getAppLoged() != null? servicePoint.getPrimary().getAppLoged() : 0;
                        engineerUser.setAppLoged(engineer.getAppLoged());
                        engineerUser.setAppFlag(engineer.getAppFlag());
                        order.getOrderCondition().setEngineer(engineerUser);
                    }
                }
                hasAuxiliaryMaterils = orderAuxiliaryMaterialService.hasAuxiliaryMaterials(order.getId(), order.getQuarter());
            }
        }
        model.addAttribute(MODEL_ATTR_ORDER, order);
        model.addAttribute("hasAuxiliaryMaterils", hasAuxiliaryMaterils? 1 : 0);
        model.addAttribute("errorFlag", errorFlag);
        if (!errorFlag) {
            model.addAttribute("fourServicePhone", MSDictUtils.getDictSingleValue("400ServicePhone", "400-666-3653"));
        } else {
            model.addAttribute("fourServicePhone", "400-666-3653");
        }
        model.addAttribute("refreshParent", StringUtils.isBlank(refreshParent) ? "true" : refreshParent);//调用方法决定是否在关闭详情页后刷新iframe
        String changed = request.getParameter("changed");
        model.addAttribute("changed", StringUtils.isBlank(changed) ? "false" : changed);
        //语音回访 2019/01/16
        Integer voiceResult = null;
        int orderStatusValue = order.getOrderCondition().getStatusValue();
        if(StringUtils.isNotBlank(order.getOrderCondition().getAppCompleteType())
                && orderStatusValue >= Order.ORDER_STATUS_SERVICED
                && order.getOrderCondition().getGradeFlag() != OrderUtils.OrderGradeType.APP_GRADE.value){
            voiceResult = orderVoiceTaskService.getVoiceTaskResult(order.getQuarter(), order.getId());
            if(voiceResult != null) {
                model.addAttribute("voiceResult", voiceResult);
            }
        }
        int praiseFlag = 0;
        OrderStatusFlag orderStatusFlag = orderStatusFlagService.getByOrderId(orderId,quarter);
        if(orderStatusFlag!=null && orderStatusFlag.getPraiseStatus() == PraiseStatusEnum.APPROVE.code){
            praiseFlag = 1;
        }
        model.addAttribute("praiseFlag",praiseFlag);
        return VIEW_NAME_NEW_ORDERDETAIL_INFO_KEFU_FORM;
    }

    /**
     * 查看历史派单订单明细(客服)
     */
    @RequestMapping(value = {"service/historyOrderDetailInfo"})
    public String kefuHistoryOrderDetailInfo(@RequestParam String id, @RequestParam String quarter, Model model,
                                      HttpServletRequest request) {
        String viewForm = "modules/sd/kefuOrderList/service/historyOrderDetailInfo";
        Boolean errorFlag = false;
        Order order = new Order();
        Long orderId = StringUtils.toLong(id);
        if (orderId <= 0) {
            errorFlag = true;
            addMessage(model, "订单代码传递错误");
        } else {
            order = orderService.getOrderById(orderId, quarter, OrderUtils.OrderDataLevel.DETAIL, true);
            if (order == null || order.getOrderCondition() == null) {
                errorFlag = true;
                addMessage(model, "错误：系统繁忙，读取订单失败，请重试。");
            } else {
                if (order.getOrderCondition().getServicePoint() != null && order.getOrderCondition().getServicePoint().getId() != null
                        && order.getOrderCondition().getServicePoint().getId() > 0
                        && order.getOrderCondition().getEngineer() != null && order.getOrderCondition().getEngineer().getId() != null
                        && order.getOrderCondition().getEngineer().getId() > 0) {
                    ServicePoint servicePoint = servicePointService.getFromCache(order.getOrderCondition().getServicePoint().getId());
                    Engineer engineer = servicePointService.getEngineerFromCache(order.getOrderCondition().getServicePoint().getId(), order.getOrderCondition().getEngineer().getId());
                    if (engineer != null) {
                        User engineerUser = new User(engineer.getId());
                        engineerUser.setName(engineer.getName());
                        engineerUser.setMobile(engineer.getContactInfo());
                        engineerUser.setSubFlag(engineer.getMasterFlag() == 1 ? 0 : 1);
//                        int appLoged = servicePoint !=null && servicePoint.getPrimary()!=null && servicePoint.getPrimary().getAppLoged() != null? servicePoint.getPrimary().getAppLoged() : 0;
                        engineerUser.setAppLoged(engineer.getAppLoged());
                        engineerUser.setAppFlag(engineer.getAppFlag());
                        order.getOrderCondition().setEngineer(engineerUser);
                    }
                }
            }
        }
        model.addAttribute(MODEL_ATTR_ORDER, order);
        model.addAttribute("errorFlag", errorFlag);
        return viewForm;
    }

    /**
     * 查看订单明细(For负责派单的客服)
     */
    @RequestMapping(value = {"service/orderDetailInfoForPlan"})
    public String kefuOrderDetailInfoForPlan(@RequestParam String id, @RequestParam String quarter, String refreshParent,
                                             HttpServletRequest request, HttpServletResponse response, Model model) {
        Boolean errorFlag = false;
        Order order = new Order();
        Long orderId = StringUtils.toLong(id);
        if (orderId <= 0) {
            errorFlag = true;
            addMessage(model, "订单代码传递错误");
        } else {
            order = orderService.getOrderById(orderId, quarter, OrderUtils.OrderDataLevel.DETAIL, true);
            if (order == null || order.getOrderCondition() == null) {
                errorFlag = true;
                addMessage(model, "错误：系统繁忙，读取订单失败，请重试。");
            } else {
                ServicePoint servicePoint = order.getOrderCondition().getServicePoint();
                if (servicePoint != null && servicePoint.getId() != null && servicePoint.getId() > 0) {
                    Engineer engineer = servicePointService.getEngineerFromCache(servicePoint.getId(), order.getOrderCondition().getEngineer().getId());
                    if (engineer != null) {
                        User engineerUser = new User(engineer.getId());
                        engineerUser.setName(engineer.getName());
                        engineerUser.setMobile(engineer.getContactInfo());
                        engineerUser.setSubFlag(engineer.getMasterFlag() == 1 ? 0 : 1);
                        order.getOrderCondition().setEngineer(engineerUser);
                    }
                }
            }
        }
        model.addAttribute(MODEL_ATTR_ORDER, order);
        model.addAttribute("errorFlag", errorFlag);
        if (!errorFlag) {
            model.addAttribute("fourServicePhone", MSDictUtils.getDictSingleValue("400ServicePhone", "400-666-3653"));
        } else {
            model.addAttribute("fourServicePhone", "400-666-3653");
        }
        model.addAttribute("refreshParent", StringUtils.isBlank(refreshParent) ? "true" : refreshParent);
        String changed = request.getParameter("changed");
        model.addAttribute("changed", StringUtils.isBlank(changed) ? "false" : changed);
        return "modules/sd/kefuOrderList/service/newOrderDefailInfoPlanForm";
    }


    /**
     * 查看订单明细(For客服处理回访)
     *
     * @param id 订单id
     * @return
     */
    @RequestMapping(value = {"service/orderDetailInfoForFollowUp"})
    public String orderDetailInfoForFollowUp(@RequestParam String id, @RequestParam String quarter, String refreshParent, Model model,
                                      HttpServletRequest request) {
        Boolean errorFlag = false;
        Order order = new Order();
        Long orderId = StringUtils.toLong(id);
        boolean hasAuxiliaryMaterils = false;
        if (orderId <= 0) {
            errorFlag = true;
            addMessage(model, "订单代码传递错误");
        } else {
            order = orderService.getOrderById(orderId, quarter, OrderUtils.OrderDataLevel.DETAIL, true);
            if (order == null || order.getOrderCondition() == null) {
                errorFlag = true;
                addMessage(model, "错误：系统繁忙，读取订单失败，请重试。");
            } else {
                if (order.getOrderCondition().getServicePoint() != null && order.getOrderCondition().getServicePoint().getId() != null
                        && order.getOrderCondition().getServicePoint().getId() > 0
                        && order.getOrderCondition().getEngineer() != null && order.getOrderCondition().getEngineer().getId() != null
                        && order.getOrderCondition().getEngineer().getId() > 0) {
                    ServicePoint servicePoint = servicePointService.getFromCache(order.getOrderCondition().getServicePoint().getId());
                    Engineer engineer = servicePointService.getEngineerFromCache(order.getOrderCondition().getServicePoint().getId(), order.getOrderCondition().getEngineer().getId());
                    if (engineer != null) {
                        User engineerUser = new User(engineer.getId());
                        engineerUser.setName(engineer.getName());
                        engineerUser.setMobile(engineer.getContactInfo());
                        engineerUser.setSubFlag(engineer.getMasterFlag() == 1 ? 0 : 1);
//                        int appLoged = servicePoint !=null && servicePoint.getPrimary()!=null && servicePoint.getPrimary().getAppLoged() != null? servicePoint.getPrimary().getAppLoged() : 0;
                        engineerUser.setAppLoged(engineer.getAppLoged());
                        engineerUser.setAppFlag(engineer.getAppFlag());
                        order.getOrderCondition().setEngineer(engineerUser);
                    }
                }
                hasAuxiliaryMaterils = orderAuxiliaryMaterialService.hasAuxiliaryMaterials(order.getId(), order.getQuarter());
            }
        }
        model.addAttribute(MODEL_ATTR_ORDER, order);
        model.addAttribute("hasAuxiliaryMaterils", hasAuxiliaryMaterils? 1 : 0);
        model.addAttribute("errorFlag", errorFlag);
        if (!errorFlag) {
            model.addAttribute("fourServicePhone", MSDictUtils.getDictSingleValue("400ServicePhone", "400-666-3653"));
        } else {
            model.addAttribute("fourServicePhone", "400-666-3653");
        }
        model.addAttribute("refreshParent", StringUtils.isBlank(refreshParent) ? "true" : refreshParent);//调用方法决定是否在关闭详情页后刷新iframe
        String changed = request.getParameter("changed");
        model.addAttribute("changed", StringUtils.isBlank(changed) ? "false" : changed);
        //语音回访 2019/01/16
        Integer voiceResult = null;
        int orderStatusValue = order.getOrderCondition().getStatusValue();
        if(StringUtils.isNotBlank(order.getOrderCondition().getAppCompleteType())
                && orderStatusValue >= Order.ORDER_STATUS_SERVICED
                && order.getOrderCondition().getGradeFlag() != OrderUtils.OrderGradeType.APP_GRADE.value){
            voiceResult = orderVoiceTaskService.getVoiceTaskResult(order.getQuarter(), order.getId());
            if(voiceResult != null) {
                model.addAttribute("voiceResult", voiceResult);
            }
        }
        int praiseFlag= 0;
        OrderStatusFlag orderStatusFlag =  orderStatusFlagService.getByOrderId(orderId,quarter);
        if(orderStatusFlag!=null && orderStatusFlag.getPraiseStatus()== PraiseStatusEnum.APPROVE.code){
            praiseFlag = 1;
        }
        model.addAttribute("praiseFlag",praiseFlag);
        return VIEW_NAME_ORDER_FOLLOWUP_DETAIL_FORM;
    }

    //endregion

    /**
     * 设定订单停滞原因 form
     *
     * @param orderId 订单id
     * @param from    调用方 0:订单列表 1:订单明细页
     */
    @RequiresPermissions(value = {"sd:order:service", "sd:order:engineeraccept"}, logical = Logical.OR)
    @RequestMapping(value = "service/pending", method = RequestMethod.GET)
    public String pending(String orderId, String quarter, Long from, HttpServletRequest request, Model model) {
        Order order = new Order();
        OrderCondition condition = new OrderCondition();
        Long orderIdLong = StringUtils.toLong(orderId);
        if (orderIdLong <= 0) {
            addMessage(model, "错误：订单参数无效");
            model.addAttribute("canSave", false);
            model.addAttribute(MODEL_ATTR_ORDER, condition);
            return VIEW_NAME_ORDER_PENDINGTYPE_FORM;
        } else {
            order = orderService.getOrderById(orderIdLong, quarter, OrderUtils.OrderDataLevel.CONDITION, true);
            if (order == null || order.getOrderCondition() == null) {
                addMessage(model, "错误：不允许改约（预约时间17点前（含），需要在当天23点前改约；预约时间17点以后的，需要在第二天23点前完成改约）。");
                model.addAttribute("canSave", false);
                model.addAttribute(MODEL_ATTR_ORDER, condition);
                return VIEW_NAME_ORDER_PENDINGTYPE_FORM;
            }
            if (order.isAllowedForSetAppointment() == 0) {
                addMessage(model, "错误：系统繁忙，读取订单失败，请重试。");
                model.addAttribute("canSave", false);
                model.addAttribute(MODEL_ATTR_ORDER, condition);
                return VIEW_NAME_ORDER_PENDINGTYPE_FORM;
            }
            if (!order.canPendingType()) {
                addMessage(model, String.format("错误：此订单不允许设置停滞原因，当前订单状态:%s", order.getOrderCondition().getStatus().getLabel()));
                model.addAttribute("canSave", false);
                model.addAttribute(MODEL_ATTR_ORDER, condition);
                return VIEW_NAME_ORDER_PENDINGTYPE_FORM;
            }
        }
        String lockkey = String.format(RedisConstant.SD_ORDER_LOCK, orderId);
        if (redisUtils.exists(RedisConstant.RedisDBType.REDIS_LOCK_DB, lockkey)) {
            addMessage(model, "错误：此订单正在处理中，请稍候重试，或刷新页面。");
            model.addAttribute("canSave", false);
            model.addAttribute(MODEL_ATTR_ORDER, condition);
            return VIEW_NAME_ORDER_PENDINGTYPE_FORM;
        }

        condition = order.getOrderCondition();
        condition.setOrderId(order.getId());
        condition.setRemarks("");
        //按排序取第一个
        List<Dict> pendingTypes = MSDictUtils.getDictExceptList("PendingType", "3");
        if (pendingTypes != null && pendingTypes.size() > 0) {
            condition.setPendingType(pendingTypes.get(0));
        }
        condition.setFeedbackId(from);//调用方

        // 时间取整点时间
        Date date = DateUtils.addDays(new Date(), 1);
        String time = DateUtils.formatDate(date, "yyyy-MM-dd 08:00:00");
        Date appointmentDate = null;
        try {
            appointmentDate = DateUtils.parse(time, "yyyy-MM-dd HH:00:00");
        } catch (java.text.ParseException e) {
            log.error("[OrderController.pending] invalid datetime:{}", time, e);
        }
        // 时间取整点时间
        order.getOrderCondition().setAppointmentDate(appointmentDate);
        model.addAttribute(MODEL_ATTR_ORDER, condition);
        return VIEW_NAME_ORDER_PENDINGTYPE_FORM;
    }

    //region 回访失败

    /**
     * 回访失败(Form)
     */
    @RequiresPermissions(value = {"sd:order:service", "sd:order:engineeraccept"}, logical = Logical.OR)
    @RequestMapping(value = "service/followUpFail", method = RequestMethod.GET)
    public String followUpFail(String orderId, String quarter, Long from, HttpServletRequest request, Model model) {
        Order order;
        OrderCondition condition = new OrderCondition();
        Long orderIdLong = StringUtils.toLong(orderId);
        if (orderIdLong <= 0) {
            addMessage(model, "错误：订单参数无效");
            model.addAttribute("canSave", false);
            model.addAttribute(MODEL_ATTR_ORDER, condition);
            return VIEW_NAME_ORDER_FOLLOWUP_FAIL_FORM;
        } else {
            order = orderService.getOrderById(orderIdLong, quarter, OrderUtils.OrderDataLevel.CONDITION, true);
            if (order == null || order.getOrderCondition() == null) {
                addMessage(model, "错误：读取订单失败，请重试。");
                model.addAttribute("canSave", false);
                model.addAttribute(MODEL_ATTR_ORDER, condition);
                return VIEW_NAME_ORDER_FOLLOWUP_FAIL_FORM;
            }
            if(0 == OrderUtils.canFollowUp(order.getOrderCondition())){
                addMessage(model, "错误：订单已处理，请确认。");
                model.addAttribute("canSave", false);
                model.addAttribute(MODEL_ATTR_ORDER, condition);
                return VIEW_NAME_ORDER_FOLLOWUP_FAIL_FORM;
            }
        }
        String lockkey = String.format(RedisConstant.SD_ORDER_LOCK, orderId);
        if (redisUtils.exists(RedisConstant.RedisDBType.REDIS_LOCK_DB, lockkey)) {
            addMessage(model, "错误：此订单正在处理中，请稍候重试，或刷新页面。");
            model.addAttribute("canSave", false);
            model.addAttribute(MODEL_ATTR_ORDER, condition);
            return VIEW_NAME_ORDER_FOLLOWUP_FAIL_FORM;
        }

        condition = order.getOrderCondition();
        condition.setRemarks("");
        model.addAttribute("canSave", true);
        model.addAttribute(MODEL_ATTR_ORDER, condition);
        return VIEW_NAME_ORDER_FOLLOWUP_FAIL_FORM;
    }

    /**
     * ajax提交回访失败
     *
     * @param order
     * @param response
     * @return
     */
    @RequiresPermissions("sd:order:return")
    @ResponseBody
    @RequestMapping(value = "service/followUpFail", method = RequestMethod.POST)
    public AjaxJsonEntity saveFollowUpFail(OrderCondition order, HttpServletResponse response)
    {
        AjaxJsonEntity result = new AjaxJsonEntity(true);
        if(order == null){
            result.setSuccess(false);
            result.setMessage("传入单据无数据.");
            return result;
        }
        try
        {
            Order o = orderService.getOrderById(order.getOrderId(),order.getQuarter(), OrderUtils.OrderDataLevel.CONDITION,true);
            if(0 == OrderUtils.canFollowUp(o.getOrderCondition())){
                result.setSuccess(false);
                result.setMessage("订单无法设定回访失败，请刷新列表后重试.");
                return result;
            }
            User user = UserUtils.getUser();
            orderService.saveFollowUpFail(order.getOrderId(),o.getOrderNo(),order.getQuarter(),order.getRemarks(),o.getOrderCondition().getStatus(),user,o.getOrderCondition().getServicePoint().getId());
        } catch (OrderException oe){
            result.setSuccess(false);
            result.setMessage(oe.getMessage());
        } catch (Exception e){
            result.setSuccess(false);
            result.setMessage(e.getMessage());
            if(order != null && order.getOrderId() != null) {
                log.error("[saveFollowUpFail] orderId:{}",order.getOrderId(),e);
            }else{
                log.error("[saveFollowUpFail]", e);
            }
        }
        return result;
    }

    //endregion

    //region 上门服务

    /**
     * 添加服务明细窗口(for待回访)
     * @param orderId 订单id
     */
    @RequiresPermissions(value = { "sd:order:service" })
    @RequestMapping(value = "service/addServiceForFollowUp")
    public String addServiceForFollowUp(@RequestParam String orderId,@RequestParam(required = false) Integer addType, Model model) {
        User user = UserUtils.getUser();
        Long lorderId = Long.valueOf(orderId);
        if (lorderId == null || lorderId <= 0) {
            addMessage(model, "参数错误");
            return VIEW_NAME_ORDER_FOLLOWUP_ADD_SERVICE_FORM;
        }
        String lockkey = String.format(RedisConstant.SD_ORDER_LOCK,orderId);
        if(redisUtils.exists(RedisConstant.RedisDBType.REDIS_LOCK_DB,lockkey)){
            addMessage(model, "错误：此订单正在处理中，请稍候重试，或刷新页面。");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_ADD_SERVICE_FORM;
        }

        Order order = orderService.getOrderById(lorderId,"", OrderUtils.OrderDataLevel.DETAIL, true);
        if (order == null || order.getOrderCondition() == null) {
            addMessage(model, "错误：系统繁忙，读取订单失败，请重试");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_ADD_SERVICE_FORM;
        }
        if (!order.canService()) {
            addMessage(model, "错误：此订单不能添加上门服务具体服务项目，请刷新订单列查看订单处理状态。");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_ADD_SERVICE_FORM;
        }
        //厂商设置远程费标识
        OrderCondition orderCondition = order.getOrderCondition();
        //List<Long> productIds = order.getItems().stream().map(OrderItem::getProductId).collect(Collectors.toList());
        //Integer customerRemoteFee = msCustomerProductService.getRemoteFeeFlag(orderCondition.getCustomer().getId(),productIds);
        Integer customerRemoteFee = 1;
        if(orderCondition.getCustomer()!=null && orderCondition.getCustomer().getId()>0){
            customerRemoteFee = orderCondition.getCustomer().getRemoteFeeFlag();
        }

        //区域远程费
        Integer areaRemoteFee = msRegionPermissionService.getRemoteFeeStatusFromCacheForSD(orderCondition.getProductCategoryId(),orderCondition.getArea().getId(),orderCondition.getSubArea().getId());
        OrderDetail detail = new OrderDetail();
        detail.setQuarter(order.getQuarter());
        detail.setOrderId(lorderId);
        if (addType != null) {
            detail.setAddType(addType);
        }
        OrderCondition condition = order.getOrderCondition();
        OrderStatus orderStatus = order.getOrderStatus();
        detail.setServicePoint(condition.getServicePoint());
        Engineer engineer = new Engineer(condition.getEngineer().getId());
        engineer.setName(condition.getEngineer().getName());
        detail.setEngineer(engineer);

        Integer times = condition.getServiceTimes();
        times = times + 1;
        detail.setServiceTimes(times);
        detail.setOrderServiceTimes(times);
        detail.setRemarks(orderStatus.getPlanComment());// 2015-01-16
        // 显示派单时的备注
        OrderItem orderItem = order.getItems().get(0);
        detail.setProduct(orderItem.getProduct());
        detail.setBrand(orderItem.getBrand());
        detail.setProductSpec(orderItem.getProductSpec());
        detail.setQty(orderItem.getQty());
        detail.setServiceType(orderItem.getServiceType());
        detail.setTravelNo(order.getOrderFee().getPlanTravelNo());// 派单时预设的远程单号

        //service Types
        //List<ServiceType> serviceTypes = serviceTypeService.findAllList();
        //订单类型 2019-12-02
        detail.setServiceCategory(new Dict(condition.getOrderServiceType(),""));
        //服务类型列表(来自数据字典)
        List<Dict> serviceCategories = MSDictUtils.getDictList(Dict.DICT_TYPE_ORDER_SERVICE_TYPE);
        if(CollectionUtils.isNotEmpty(serviceCategories)){
            serviceCategories = serviceCategories.stream().filter(t->t.getIntValue()>0).collect(Collectors.toList());
        }
        model.addAttribute("serviceCategories",serviceCategories);
        model.addAttribute("canService","true");
        model.addAttribute("item", detail);
        model.addAttribute("order", order);
        model.addAttribute("customerRemoteFee",customerRemoteFee);
        model.addAttribute("areaRemoteFee",areaRemoteFee);
        return VIEW_NAME_ORDER_FOLLOWUP_ADD_SERVICE_FORM;
    }

    /**
     * 修改服务明细窗口(for待回访)
     * @param orderId 订单id
     */
    @RequiresPermissions(value = { "sd:order:service" })
    @RequestMapping(value = "service/editServiceForFollowUp")
    public String editServiceForFollowUp(@RequestParam String orderId,@RequestParam String detailId,@RequestParam String quarter, Model model) {
        User user = UserUtils.getUser();
        Long lorderId = Long.valueOf(orderId);
        if (lorderId == null || lorderId <= 0) {
            addMessage(model, "参数错误");
            return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
        }

        Long ldetailId = Long.valueOf(detailId);
        if (ldetailId == null || ldetailId <= 0) {
            addMessage(model, "参数错误");
            return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
        }

        Order order = orderService.getOrderById(lorderId,quarter, OrderUtils.OrderDataLevel.DETAIL, true);
        if (order == null || order.getOrderCondition() == null) {
            addMessage(model, "错误：系统繁忙，读取订单失败，请重试");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
        }
        if (!order.canService()) {
            addMessage(model, "错误：此订单不能修改上门服务项目，请刷新订单列查看订单处理状态。");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
        }
        List<OrderDetail> details = order.getDetailList();
        if(details== null || details.isEmpty()){
            addMessage(model, "错误：此订单无上门服务项目。");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
        }
        OrderDetail detail = details.stream().filter(t->t.getId().equals(ldetailId)).findFirst().orElse(null);
        if(detail == null){
            addMessage(model, "错误：此订单无此上门服务项目，请确认。");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
        }
        if(detail.getDelFlag() == 1){
            addMessage(model, "错误：此上门服务项目已删除。");
            model.addAttribute("canService","false");
            return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
        }
        OrderCondition condition = order.getOrderCondition();
        //厂商设置远程费标识
        //List<Long> productIds = order.getItems().stream().map(OrderItem::getProductId).collect(Collectors.toList());
        //Integer customerRemoteFee = msCustomerProductService.getRemoteFeeFlag(condition.getCustomer().getId(),productIds);

        Integer customerRemoteFee = 1;
        if(condition.getCustomer()!=null && condition.getCustomer().getId()>0){
            customerRemoteFee = condition.getCustomer().getRemoteFeeFlag();
        }

        //区域远程费
        Integer areaRemoteFee = msRegionPermissionService.getRemoteFeeStatusFromCacheForSD(condition.getProductCategoryId(),condition.getArea().getId(),condition.getSubArea().getId());
        //订单类型 2019-12-02
        //detail.setServiceCategory(new Dict(condition.getOrderServiceType(),""));
        //服务类型列表(来自数据字典)
        List<Dict> serviceCategories = MSDictUtils.getDictList(Dict.DICT_TYPE_ORDER_SERVICE_TYPE);
        if(CollectionUtils.isNotEmpty(serviceCategories)){
            serviceCategories = serviceCategories.stream().filter(t->t.getIntValue()>0).collect(Collectors.toList());
        }
        model.addAttribute("serviceCategories",serviceCategories);
        //编辑上门服务时使用
        List<MDErrorType> errorTypes = null;
        List<MDErrorCode> errorCodes = null;
        List<MDActionCodeDto> actionCodes = null;
        List<ServiceType> serviceTypes = null;
        //非安装
        long pid = detail.getProduct().getId();
        if(detail.getServiceCategory().getIntValue() > 1){
            errorTypes = msErrorTypeService.findErrorTypesByProductId(pid);
            if(detail.getErrorType().getId() > 0) {
                errorCodes = msErrorCodeService.findListByProductAndErrorType(detail.getErrorType().getId(), pid);
                if(detail.getErrorCode().getId() > 0) {
                    actionCodes = msActionCodeService.findListByProductAndErrorCode(detail.getErrorCode().getId(),pid);
                    /*
                    if(detail.getActionCode().getId() > 0){
                        //目前一个故障处理对应一个服务类型
                        serviceTypes = Lists.newArrayList(detail.getServiceType());
                    }else{
                        //按订单类型装载多个服务类型
                        serviceTypes = serviceTypeService.findListOfOrderType(detail.getServiceCategory().getIntValue());
                    }*/
                }
            }/*else{
                //按订单类型装载多个服务类型
                serviceTypes = serviceTypeService.findListOfOrderType(detail.getServiceCategory().getIntValue());
            }*/
            serviceTypes = serviceTypeService.findListOfOrderType(detail.getServiceCategory().getIntValue());
        }else{
            //安装
            serviceTypes = serviceTypeService.findListOfOrderType(detail.getServiceCategory().getIntValue());
        }
        detail.setHasErrorType(1);
        if(CollectionUtils.isEmpty(errorTypes)){
            detail.setHasErrorType(0);
        }
        model.addAttribute("errorTypes",errorTypes==null?Lists.newArrayList():errorTypes);
        model.addAttribute("errorCodes",errorCodes==null?Lists.newArrayList():errorCodes);
        model.addAttribute("actionCodes",actionCodes==null?Lists.newArrayList():actionCodes);
        model.addAttribute("serviceTypes",serviceTypes==null?Lists.newArrayList():serviceTypes);
        //service Types
        model.addAttribute("canService","true");
        model.addAttribute("item", detail);
        model.addAttribute("order", order);
        model.addAttribute("customerRemoteFee",customerRemoteFee);
        model.addAttribute("areaRemoteFee",areaRemoteFee);
        return VIEW_NAME_ORDER_FOLLOWUP_EDIT_SERVICE_FORM;
    }

    // ajax 修改服务明细(for待回访)
    @RequiresPermissions(value = "sd:order:service")
    @ResponseBody
    @RequestMapping(value = "service/saveServiceForFollowUp")
    public AjaxJsonEntity saveServiceForFollowUp(OrderDetail detail, Model model, HttpServletResponse response)
    {
        User user = UserUtils.getUser();

        response.setContentType("application/json; charset=UTF-8");
        AjaxJsonEntity jsonEntity = new AjaxJsonEntity();
        jsonEntity.setSuccess(true);

        if (!beanValidator(model, detail))
        {
            jsonEntity.setSuccess(false);
            if (model.containsAttribute("message"))
            {
                jsonEntity.setMessage((String) model.asMap().get("message"));
            } else
            {
                jsonEntity.setMessage("输入错误，请检查。");
            }
            return jsonEntity;
        }

        try
        {
            Date date = new Date();
            detail.setCreateBy(user);
            detail.setCreateDate(date);
            detail.setUpdateBy(user);
            detail.setUpdateDate(date);
            if(detail.getId() == null || detail.getId()==0){
                kefuOrderListService.addDetailForFollowUp(detail);
            }else {
                kefuOrderListService.editDetailForFollowUp(detail);
            }
        } catch (Exception e)
        {
            jsonEntity.setSuccess(false);
            jsonEntity.setMessage(e.getMessage());
        }

        return jsonEntity;
    }

    /**
     * 删除订单实际服务项目
     *
     * @param id 服务项目ID
     */
    @RequiresPermissions("sd:order:service")
    @ResponseBody
    @RequestMapping(value = "service/ajaxDelServiceForFollowUp")
    public AjaxJsonEntity ajaxDelServiceForFollowUp(@RequestParam(required = false) String id, @RequestParam(required = false) String orderId, HttpServletResponse response)
    {
        User user = UserUtils.getUser();
        response.setContentType("application/json; charset=UTF-8");
        AjaxJsonEntity jsonEntity = new AjaxJsonEntity();
        jsonEntity.setSuccess(true);
        Long lid = Long.valueOf(id);
        if (lid == null || lid <=0)
        {
            jsonEntity.setSuccess(false);
            jsonEntity.setMessage("服务项目编号错误，无法删除");
            return jsonEntity;
        }

        try {
            Long lorderId = Long.valueOf(orderId);
            if(lorderId==null || lorderId<=0){
                jsonEntity.setSuccess(false);
                jsonEntity.setMessage("订单id错误，无法删除");
            }else {
                Date date = new Date();
                OrderDetail detail = new OrderDetail();
                detail.setOrderId(lorderId);
                detail.setId(lid);
                detail.setCreateBy(user);
                detail.setCreateDate(date);
                kefuOrderListService.deleteDetailForFollowUp(detail);
                jsonEntity.setMessage("删除服务项目成功");
            }
        }catch (Exception e)
        {
            jsonEntity.setSuccess(false);
            jsonEntity.setMessage(e.getMessage());
        }

        return jsonEntity;
    }


    /**
     * 确认上门(ajax for待回访)
     *
     * @param orderId
     * @param confirmType 确认类型: 0-客服 1-网点
     * @return
     */
    @ResponseBody
    @RequestMapping(value = "service/confirmDoorAutoForFollowUp", method = RequestMethod.POST)
    public AjaxJsonEntity confirmDoorAutoForFollowUp(String orderId,String quarter, Integer confirmType, HttpServletResponse response)
    {
        User user = UserUtils.getUser();
        AjaxJsonEntity result = new AjaxJsonEntity(true);
        try
        {
            if(confirmType == null){
                confirmType = 0;
            }
            Long lorderId = Long.valueOf(orderId);
            kefuOrderListService.confirmDoorAutoForFollowUp(lorderId,quarter,user,confirmType);
        } catch (OrderException oe){
            result.setSuccess(false);
            result.setMessage(oe.getMessage());
        } catch (Exception e){
            result.setSuccess(false);
            result.setMessage(e.getMessage());
            log.error("[OrderController.confirmDoorAuto] orderId:{}",orderId, e);
        }
        return result;
    }

    /**
     * 取消APP异常(ajax)
     *
     * @param orderId
     * @param response
     * @return
     */
    @ResponseBody
    @RequestMapping(value = "orderDealAPPException", method = RequestMethod.POST)
    public AjaxJsonEntity orderDealAPPException(String orderId,String quarter, HttpServletResponse response)
    {
        AjaxJsonEntity result = new AjaxJsonEntity(true);
        try
        {
            Long lorderId = Long.valueOf(orderId);
            orderService.dealAPPException(lorderId,quarter);
        } catch (OrderException oe){
            result.setSuccess(false);
            result.setMessage(oe.getMessage());
        } catch (Exception e){
            result.setSuccess(false);
            result.setMessage("订单异常处理发生异常:" + e.getMessage());
            log.error("[OrderController.orderDealAPPException] orderId:{}",orderId, e);
        }
        return result;
    }


    /**
     * 转到预约到期列表(ajax)
     *
     * @param orderId
     * @param response
     * @return
     */
    @ResponseBody
    @RequestMapping(value = "service/toArriveAppointment", method = RequestMethod.POST)
    public AjaxJsonEntity toArriveAppointment(String orderId,String quarter, HttpServletResponse response)
    {
        AjaxJsonEntity result = new AjaxJsonEntity(true);
        try
        {
            User user = UserUtils.getUser();
            Long lorderId = Long.valueOf(orderId);
            Order order = new Order(lorderId);
            order.setQuarter(quarter);
            order.setCreateBy(user);
            kefuOrderListService.toArriveAppointment(order);
        } catch (OrderException oe){
            result.setSuccess(false);
            result.setMessage(oe.getMessage());
        } catch (Exception e){
            result.setSuccess(false);
            result.setMessage("移转预约到期处理发生异常:" + e.getMessage());
            log.error("[toArriveAppointment] orderId:{}",orderId, e);
        }
        return result;
    }

    //endregion 上门服务

    //endregion 客服操作

    @RequestMapping(value="locateAddress")
    public String locateAddress(String address, Model model) {
        try {
            String addr =java.net.URLDecoder.decode(address,"UTF-8");  //进行解码，会抛异常，直接捕获即可。
            String[] areaArray = AreaUtils.getLocation(address);
            Double  centerLongtitude =0.0,
                    centerLatitude = 0.0;

            if (!ObjectUtils.isEmpty(areaArray) && areaArray.length == 2) {
                centerLongtitude = Double.valueOf(areaArray[0]);
                centerLatitude = Double.valueOf(areaArray[1]);
            }
            model.addAttribute("centerLng",centerLongtitude);
            model.addAttribute("centerLat",centerLatitude);
            model.addAttribute("address", addr);
        } catch (UnsupportedEncodingException e) {
            log.error("地址解析失败",e);
        }
        return "modules/sd/kefuOrderList/locateServiceAddress";
    }

    /**
     * 根据客户id和产品获取产品安装规范
     *
     * @param customerId
     * @param productId
     * @return
     */
    @RequestMapping("getProductFixSpec")
    public String getProductFixSpec(Long customerId,Long productId,Model model){
        model.addAttribute("canSave",true);
        CustomerProduct customerProduct = msCustomerProductService.getFixSpecFromCache(customerId,productId);
        if(customerProduct!=null){
            model.addAttribute("customerProduct",customerProduct);
        }else{
            model.addAttribute("customerProduct",new CustomerProduct());
        }
        return "modules/sd/kefuOrderList/service/productFixSpecView";
    }
}

