<!DOCTYPE html>
<%@ page contentType="text/html;charset=UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>
<html>
<head>
	<title>申请配件</title>
	<%@ include file="/WEB-INF/views/include/head.jsp" %>
	<meta name="decorator" content="default" /> 
	<%@include file="/WEB-INF/views/include/dialog.jsp"%>
	<%@include file="/WEB-INF/views/include/treetable.jsp" %>
	<script src="${ctxStatic}/js/fixtable.js" type="text/javascript"></script>
	<script src="${ctxStatic}/sd/Order.js?_v=${OrderJsVersion}" type="text/javascript"></script>
	<link href="${ctxStatic}/jquery-upload-file/css/uploadfile.min.css" rel="stylesheet">
	<script src="${ctxStatic}/js/ajaxfileupload.js"></script>
	<script src="${ctxStatic}/common/doT.min.js" type="text/javascript"></script>
	<script id="tpl-attachment-row" type="text/x-dot-template">
		{{? it.id }}
		<tr id="attach_tr_{{=it.id}}">
			<td><a href="${ctxUpload}/{{=it.filePath}}" target="_blank">{{=it.remarks}}</a></td>
			<td>{{=it.createDate}}</td>
			<td>
				<a class="" href="javascript:;" data-rowid="{{=it.id}}" onclick="delRow('{{=it.id}}');" title="刪除">
					<i class="icon-delete" style="margin-top: 0px;"></i>
				</a>
				<input type="hidden" id="id{{=it.id}}" name="id{{=it.id}}" value="{{=it.id}}" />
			</td>
		</tr>
		{{?}}
	</script>
	<script type="text/javascript">
		<%String parentIndex = request.getParameter("parentIndex");%>
		var parentIndex = '<%=parentIndex==null?"":parentIndex %>';
		Order.rootUrl = "${ctx}";
		var clickTag = 0;
		var $btnSubmit = $("#btnSubmit");
        var this_index = top.layer.index;
		$(document).ready(function(){
			$("#treeTable").treeTable({expandLevel : 2});
			$("#buttonUploadLogo").click(function() {
                var $btn = $(self);
                if (clickTag == 1){
                    return false;
                }
                clickTag = 1;
                $btn.attr('disabled', 'disabled');
                $btnSubmit.attr('disabled', 'disabled');
				uploadfile($("#logo"),$("#logo_image"), "fileToUploadlogo");
				return false;
			});

			$("#btnSubmit").click(function(event){
			    if(clickTag == 1){
                    event.preventDefault();
			        return false;
				}
				clickTag = 1;
				if($("#treeTable input[type='checkbox']:checked").length ==0){
                    event.preventDefault();
					layerAlert('请选择至少一个配件!');
                    clickTag = 0;
					return false;
				}
                $btnSubmit.attr('disabled', 'disabled');
                var ajaxSuccess = 0;
                var applyForm = {};
                applyForm.quarter = $("#quarter").val();
                applyForm.orderId = $("#orderId").val();
                applyForm.productId = $("#productId").val();
                applyForm.orderDetailId = $("#orderDetailId").val();
                applyForm.remarks = $("#remarks").val();

                var option = $("[name='applyType']:checked");
                var applyType = {};
                applyType["value"] = option.val();
                lblid = option.attr("id");
                applyType["label"] = $("label[for='" + lblid + "']").text();
                applyForm.applyType = applyType;
				//对应productGroup,Map<ProductId,List<MaterialItem>>
                var materials = {};
                var items = [];
                var parentRowId,rowId;
                var parentRow,product;
                var rowProducts = {};
                var products = {};//提交的产品列表
                var row,item,pid,pname,pbrand,pmodel,pserviceid,pservicename,pwarranty;
                $("input[type='checkbox'][name='chooseFlag']:checkbox:checked").each(function(index,element){
                    parentRowId = $(this).data('parentrowid');
                    product = rowProducts[parentRowId];
                    if(!product){
                        parentRow = $("#" + parentRowId);
                        pid = parentRow.data("pid");
                        pname = parentRow.data("pname");
						pbrand = parentRow.data("brand");
						pmodel = parentRow.data("model");
						pserviceid = parentRow.data("servicetypeid");
						pservicename = parentRow.data("servicetypename");
						pwarranty = parentRow.data("warranty");
                        product = {id:pid,name:pname,brand:pbrand,model:pmodel,serviceType:{id:pserviceid,name:pservicename,warrantyStatus:{value:pwarranty}}};
						rowProducts[parentRowId] = product;
						products[pid] = product;
                        materials[pid]= [];
					}
					items = materials[product.id];
                    rowId = $(this).data("rowid");
					row = $("#" + rowId);
					item = {};
					var material = {};
					material["id"] = row.find("#mId").val();
					material["name"] = row.find("#mName").val();
					item["material"] = material;
					item["qty"] = row.find("#qty").val();
					item["returnFlag"] = row.find("#returnFlag").val();
					item["price"] = row.find("#price").val();
					item["factoryPrice"] = row.find("#factoryPrice").val();
					items.push(item);
                });
                applyForm.productGroup = materials;
                applyForm.products = products;
                /* test code
                console.log('data:');
                console.log(JSON.stringify(applyForm));
                clickTag = 0;
				$btnSubmit.removeAttr('disabled');
				return false;
                 */
                var loadingIndex;
                $.ajax({
                    async: false,
                    cache: false,
                    type: "POST",
                    url: "${ctx}/sd/material/saveMaterialApply?at="+ (new Date()).getTime(),
                    data: {"materialMaster":JSON.stringify(applyForm)},
                    dataType: 'json',
                    beforeSend: function () {
                        loadingIndex = top.layer.msg('正在提交，请稍等...', {
                            icon: 16,
                            time: 0,//不定时关闭
                            shade: 0.3
                        });
                    },
                    complete: function () {
                        if(ajaxSuccess == 0) {
                            setTimeout(function () {
                                clickTag = 0;
                                $btnSubmit.removeAttr('disabled');
                            }, 2000);
                        }
                    },
                    success: function (data) {
                        if(ajaxLogout(data)){
                            return false;
                        }
                        if(loadingIndex) {
                            top.layer.close(loadingIndex);
                        }
                        if(data && data.success == true){
                            layerMsg(data.message);
                            $("#inputForm").resetForm();
                            $("#tbd_attach tr").remove();
							var layero = $("#layui-layer" + (parentIndex || '0'), top.document);
							var iframeWin = top[layero.find('iframe')[0]['name']];
							if(iframeWin) {
								iframeWin.refreshMaterialButton();
							}
                            ajaxSuccess = 1;
                        }
                        else if( data && data.message){
                            layerError(data.message,"错误提示");
                        }
                        else{
                            layerError("配件申请错误","错误提示");
                        }
                        return false;
                    },
                    error: function (e) {
                        ajaxLogout(e.responseText,null,"配件申请错误，请重试!");
                    }
                });
			});

			$("input[name='chooseFlag']").change(function() {
				var $check = $(this);
				var trid = $check.data("rowid");
				if(trid){
					if ($check.attr("checked") == "checked") {
						$("#" + trid).addClass("info");
					}else{
						$("#" + trid).removeClass("info");
					}
				}
			});
		});

		function uploadfile($obj1, $obj1_image, obj2)
		{
			var data =
			{
				fileName : $obj1.val()
			};
			$.ajaxFileUpload({
				url : '${pageContext.request.contextPath}/servlet/Upload?fileName=' + $obj1.val(),//处理图片脚本
				secureuri : false,
				data : data,
				fileElementId : obj2,//file控件id
				dataType : 'json',
                complete: function () {
					setTimeout(function () {
						clickTag = 0;
						//$('#buttonUploadLogo').removeAttr('disabled');
						refreshUploadButon();
						$btnSubmit.removeAttr('disabled');
					}, 2000);
                },
				success : function(data, status)
				{
                    if(ajaxLogout(data)){
                        return false;
                    }
					$obj1.val(data.fileName);
					$("#orignalName").val(data.origalName);

					if(data.origalName =="" )
					{
						layerAlert("请先选择照片，再点击上传","提示");
						return true;
					}
					//save to system
					var param = {};
					param.logo = $("#logo").val();
					param.orignalName = data.origalName;
					param.orderDetailId = $("#orderDetailId").val();
					param.orderId = $("#orderId").val();
					param.productId = $("#productId").val();
					param.quarter = $("#quarter").val();

					$.ajax(
						{
							cache : false,
							type : "POST",
							async : false,
							url : "${ctx}/sd/material/ajax/saveMaterialApplyTempAttachment",
							data : param,
							success : function(data)
							{
                                if(ajaxLogout(data)){
                                    return false;
                                }
								if (data)
								{
									if (data && data.success == true)
									{
                                        var tplId = "tpl-attachment-row";
                                        var tmpl = document.getElementById(tplId).innerHTML;
                                        var doTtmpl = doT.template(tmpl);
                                        var html = doTtmpl(data.data);
                                        $("#tbd_attach").append(html);
										refreshUploadButon();
                                        layerMsg("照片上传成功",true);
									} else
									{
										layerError("照片上传失败!");
									}
								}
								return false;
							},
							error : function(e)
							{
								layerError("照片上传失败!");
							}
						});

				},
				error : function(e)
				{
                    ajaxLogout(e.responseText,null,"照片上传错误，请重试!");
				}
			});
		}

		function delRow(i)
		{
			if (!i)
			{
				return false;
			}
            var id = $("#id" + i).val();
            if (id.length == 0){
                return false;
			}
			var confirmClickTag = 0;
			top.layer.confirm('确认删除?', {
			    zIndex:29991016
				,icon: 3
				,title:'系统确认'
                ,cancel: function(index, layero){}
			}, function(index,layero){
				if(confirmClickTag == 1){
				    return false;
				}
                var btn0 = $(".layui-layer-btn0",layero);
                if(btn0.hasClass("layui-btn-disabled")){
                    return false;
                }
                confirmClickTag = 1;
                btn0.addClass("layui-btn-disabled").attr("disabled","disabled");
                top.layer.close(index);
				var data1 =
					{
						attachmentId : id,
						orderId : $("#orderId").val(),
						orderDetailId : $("#orderDetailId").val(),
						productId: $("#productId").val()
					};
				$.ajax(
					{
						cache : false,
						type : "POST",
						async : false,
						url : "${ctx}/sd/material/deleteMaterialApplyAttachment",
						data : data1,
                        beforeSend: function () {
                        },
                        complete: function () {
                        },
						success : function(data)
						{
							if(ajaxLogout(data)){
								return false;
							}
							if (data)
							{
								if (data && data.success == true)
								{
									$("#attach_tr_" + i).remove();
									refreshUploadButon();
								} else
								{
									layerError(" 删除失败，请重试!");
								}
							}
							return false;
						},
						error : function(e)
						{
							ajaxLogout(e.responseText,null,"删除失败，请重试!");
						}
					});
			});
		}
		function refreshUploadButon(){
			if($("[id^='attach_tr_']").length >=9){
				$('#buttonUploadLogo').attr('disabled', 'disabled');
			}else{
				$('#buttonUploadLogo').removeAttr('disabled');
			}
		}

	</script>
<style type="text/css">
	.table th,.table td {  padding: 4px;  }
	.table thead th,.table tbody td {  text-align: center;  vertical-align: middle;  }
	.table .tdcenter {  text-align: center;  vertical-align: middle;  }
	.alert {padding: 4px 5px 4px 4px;  }
	.span-tr { padding: 4px 5px 4px 0px;}
	.span-product {margin-left: 10px;float: left; margin-bottom: 0px !important;}
</style>
</head>
<body style="margin-bottom: 5px;">
	<form:form id="inputForm" modelAttribute="materialMaster" method="post" class="form-horizontal">
		<sys:message content="${message}" />
		<c:if test="${canAction}">
		<input type="hidden" id="parentIndex" name="parentIndex" value="${parentIndex}" />
		<form:hidden path="orderId" />
		<form:hidden path="quarter" />
		<form:hidden path="orderDetailId" />
		<!-- 存储原始产品id,套组不变，用来查找上门服务 -->
		<form:hidden path="productId" />
		<form:hidden path="product.id" />
		<form:radiobuttons path="applyType" items="${fns:getDictListFromMS('material_apply_type')}" itemLabel="label"
							itemValue="value" htmlEscape="false" class="required" /> <%-- 切换为微服务 --%>
		<table id="treeTable" class="table table-striped table-bordered table-condensed" style="margin-top: 20px;">
			<thead>
				<tr>
					<th width="60px">选择</th>
					<th>配件名称</th>
					<th width="80px">数量</th>
					<th width="100px">是否返件</th>
					<th width="100px">价格</th>
					<th width="100px">参考价格</th>
				</tr>
			</thead>
			<tbody>
				<c:set var="idx" value="-1"/>
				<c:forEach items="${materialMaster.mateirals}" var="map" varStatus="i" begin="0">
					<tr id="tr_${i.index+1}" pId="0"
							data-pid="${map.key.id}" data-pname="${map.key.name}" data-brand="${map.key.brand}"
							data-model="${map.key.model}" data-servicetypeid="${map.key.serviceType.id}" data-servicetypename="${map.key.serviceType.name}"
							data-warranty="${map.key.serviceType.warrantyStatus.value}"
					>
						<td>${i.index+1}</td>
						<td colspan="5" style="text-align:left;">
							<span class="span-product alert alert-success">${map.key.name}</span> <span class="span-tr">品牌: ${map.key.brand}</span> <span class="span-tr">型号: ${map.key.model}</span> <span class="span-tr">服务: ${map.key.serviceType.name}</span>
						</td>
					</tr>
					<c:forEach items="${map.value}" var="materialItem" varStatus="j" begin="0">
						<c:set var="idx" value="${idx + 1}"/>
						<tr id="tr_${i.index}_${j.index}" pId="tr_${i.index+1}">
							<td>
								<input type="checkbox" data-parentrowid="tr_${i.index+1}" data-rowid="tr_${i.index}_${j.index}" name="chooseFlag" cssclass="chkitem"/>
							</td>
							<td>${materialItem.material.name}
								<input type="hidden" id="mId" value="${materialItem.material.id}"/>
								<input type="hidden" id="mName" value="${materialItem.material.name}"/>
							</td>
							<td><input type="text" id="qty" value="${materialItem.qty}"
											htmlEscape="false" maxlength="7" class="required number int input-mini" />
							</td>
							<td>
								<c:choose>
									<c:when test="${materialItem.returnFlag == 1}"><span class="label label-important">是</span></c:when>
									<c:otherwise>否</c:otherwise>
								</c:choose>
								<input type="hidden" id="returnFlag" value="${materialItem.returnFlag}"/>
							</td>
							<td><input type="text" id="price" value="${materialItem.price}" htmlEscape="false" maxlength="7" class="required number double input-mini"/></td>
							<td><input type="text" id="factoryPrice" readonly="readonly" value="${materialItem.factoryPrice}" htmlEscape="false" maxlength="7" class="required number double input-mini"/></td>
						</tr>
					</c:forEach>
				</c:forEach>

			</tbody>
		</table>
		<div><label style="padding-right: 10px;">故障描述:</label>
			<form:textarea path="remarks" htmlEscape="false" rows="2" maxlength="255" class="input-xlarge" style="width: 90%;" />
		</div>
		<legend>配件照片上传</legend>
		<!-- 限制上传照片不能超过9个 -->
			<c:set var="attachSize" value="0"/>
		<c:if test="${attachments != null}">
			<c:set var="attachSize" value="${attachments.size()}" />
		</c:if>
		<div>
			<img id="logo_image" class="logo_image" alt="" />
			<input name="logo" id="logo" type="hidden"  htmlEscape="false" /> 
			<input name="orignalName" id="orignalName" type="hidden" htmlEscape="false" /> 
			<input id="fileToUploadlogo" type="file" style="width: 250px;"
				size="20" name="fileToUploadlogo" value="${fileToUploadlogo}" >
			<button id="buttonUploadLogo" type="button" <c:if test="${attachSize>=9}">disabled="disabled"</c:if> class="btn">上传</button>
		</div>

		<fieldset style="padding-top: 20px;">
			<table id="tb_attach" width="100%" border="0" class="table table-striped table-bordered table-condensed"
					style="margin-bottom: 0px;">
					<thead>
						<tr>
							<td width="100">名称</td>
							<td width="80">时间</td>
							<td width="20"></td>
						</tr>
					</thead>
				<tbody id="tbd_attach">
					<c:set var="index" value="0"></c:set>
					<c:forEach items="${attachments}" var="attach" varStatus="i" begin="0">
						<tr id="attach_tr_${i.index}">
							<td><a href="${ctxUpload}/${attach.filePath}" target="_blank">${attach.remarks}</a></td>
							<td><fmt:formatDate value="${attach.createDate}" pattern="yyyy-MM-dd"/></td>
							<td>
								<a class="" href="javascript:;" data-rowid="${i.index}" onclick="delRow('${i.index}');" title="刪除">
									<i class="icon-delete" style="margin-top: 0px;"></i>
								</a>
								<input type="hidden" id="id${i.index}" name="id${i.index}" value="${attach.id}" />
							</td>
						</tr>
					</c:forEach>
				</tbody>
				</table>
		</fieldset>
		
		<div class="form-actions">
				<input id="btnSubmit" class="btn btn-primary" type="button" value="保 存" />
		</div>
		</c:if>
	</form:form>
</body>
</html>