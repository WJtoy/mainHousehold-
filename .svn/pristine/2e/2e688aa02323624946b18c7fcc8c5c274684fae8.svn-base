/**
 * Copyright &copy; 2012-2016 <a href="https://github.com/thinkgem/jeesite">JeeSite</a> All rights reserved.
 */
package com.wolfking.jeesite.modules.sd.service;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Sets;
import com.wolfking.jeesite.common.config.redis.GsonRedisSerializer;
import com.wolfking.jeesite.common.persistence.LongIDBaseEntity;
import com.wolfking.jeesite.common.persistence.Page;
import com.wolfking.jeesite.common.service.LongIDBaseService;
import com.wolfking.jeesite.common.utils.DateUtils;
import com.wolfking.jeesite.common.utils.QuarterUtils;
import com.wolfking.jeesite.modules.fi.dao.CustomerCurrencyDao;
import com.wolfking.jeesite.modules.md.dao.CustomerFinanceDao;
import com.wolfking.jeesite.modules.md.dao.ServicePointDao;
import com.wolfking.jeesite.modules.md.entity.*;
import com.wolfking.jeesite.modules.md.service.ServicePointService;
import com.wolfking.jeesite.modules.md.service.ServiceTypeService;
import com.wolfking.jeesite.modules.md.service.UrgentLevelService;
import com.wolfking.jeesite.modules.md.utils.ProductUtils;
import com.wolfking.jeesite.modules.sd.dao.*;
import com.wolfking.jeesite.modules.sd.entity.Order;
import com.wolfking.jeesite.modules.sd.entity.OrderDetail;
import com.wolfking.jeesite.modules.sd.entity.OrderItem;
import com.wolfking.jeesite.modules.sd.entity.viewModel.OrderSearchModel;
import com.wolfking.jeesite.modules.sd.entity.viewModel.OrderServicePointSearchModel;
import com.wolfking.jeesite.modules.sd.utils.OrderItemUtils;
import com.wolfking.jeesite.modules.sd.utils.OrderUtils;
import com.wolfking.jeesite.modules.sys.dao.UserDao;
import com.wolfking.jeesite.modules.sys.entity.Dict;
import com.wolfking.jeesite.modules.sys.entity.User;
import com.wolfking.jeesite.ms.utils.MSDictUtils;
import com.wolfking.jeesite.ms.utils.MSUserUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * 网点工单列表
 */
@Service
@Transactional(propagation = Propagation.NOT_SUPPORTED)
public class ServicePointOrderService extends LongIDBaseService {

    /**
     * 持久层对象
     */
    @Resource
    protected OrderDao dao;

//    @Resource
//    private ServicePointOrderDao servicePointOrderDao;

    @Resource
    protected CustomerFinanceDao customerFinanceDao;

    @Resource
    protected CustomerCurrencyDao customerCurrencyDao;

    @Resource
    protected ServicePointDao servicePointDao;

    @Resource
    protected OrderAttachmentDao attachmentDao;

    @Resource
    protected OrderComplainDao complainDao;

    @Resource
    protected UserDao userDao;

    @Resource
    protected FeedbackDao feedbackDao;

    @Autowired
    private ServicePointService servicePointService;

    @Autowired
    private OrderService orderService;

    @Autowired
    private UrgentLevelService urgentLevelService;

    @Autowired
    private ServiceTypeService serviceTypeService;

    @Autowired
    public RedisTemplate redisTemplate;

    @Resource(name = "gsonRedisSerializer")
    public GsonRedisSerializer gsonRedisSerializer;

    /**
     * 获取网点待预约的工单
     *
     * @param page
     * @param searchModel
     * @return
     */
    public Page<Order> findServicePointWaitingAppointmentOrder(Page<OrderServicePointSearchModel> page, OrderServicePointSearchModel searchModel) {
        searchModel.setPage(page);
        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = searchModel.getEndAcceptDate() == null ? new Date() : searchModel.getEndAcceptDate();
        Date date;
        if (searchModel.getBeginAcceptDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(searchModel.getBeginAcceptDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -5);//5个月
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
            searchModel.setBeginAcceptDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            int size = quarters.size();
            if (size > 2) {
                searchModel.setQuarters(Lists.newArrayList(quarters.get(size - 1), quarters.get(size - 2)));
            } else {
                searchModel.setQuarters(quarters);
            }
        }
        Date appointDate = DateUtils.getEndOfDay(new Date());
        searchModel.setAppointmentDate(appointDate);
//        List<Order> orderList = servicePointOrderDao.getWaitingAppointmentOrderList(searchModel);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());

        if (orderList != null && orderList.size() > 0) {
            setOrderProperties(orderList);
            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }

        return rtnPage;
    }

    /**
     * 获取网点处理中的工单
     *
     * @param page
     * @param searchModel
     * @return
     */
    public Page<Order> findServicePointProcessingOrder(Page<OrderServicePointSearchModel> page, OrderServicePointSearchModel searchModel) {
        searchModel.setPage(page);
        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = searchModel.getEndAcceptDate() == null ? new Date() : searchModel.getEndAcceptDate();
        Date date;
        if (searchModel.getBeginAcceptDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(searchModel.getBeginAcceptDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -9);//9个月
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
            searchModel.setBeginAcceptDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            searchModel.setQuarters(quarters);
        }
        Date appointDate = DateUtils.getEndOfDay(new Date());
        searchModel.setAppointmentDate(appointDate);
//        List<Order> orderList = servicePointOrderDao.getProcessingOrderList(searchModel);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());

        if (orderList != null && orderList.size() > 0) {
            setOrderProperties(orderList);
            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }

        return rtnPage;
    }

    /**
     * 获取网点处理中的工单
     *
     * @param page
     * @param searchModel
     * @return
     */
    public Page<Order> findServicePointAppointedOrder(Page<OrderServicePointSearchModel> page, OrderServicePointSearchModel searchModel) {
        searchModel.setPage(page);
        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = searchModel.getEndAcceptDate() == null ? new Date() : searchModel.getEndAcceptDate();
        Date date;
        if (searchModel.getBeginAcceptDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(searchModel.getBeginAcceptDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -9);//9个月
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
            searchModel.setBeginAcceptDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            searchModel.setQuarters(quarters);
        }
        Date appointDate = DateUtils.getEndOfDay(new Date());
        searchModel.setAppointmentDate(appointDate);
//        List<Order> orderList = servicePointOrderDao.getAppointedOrderList(searchModel);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());

        if (orderList != null && orderList.size() > 0) {
            setOrderProperties(orderList);
            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }

        return rtnPage;
    }

    /**
     * 获取网点等配件的工单
     *
     * @param page
     * @param searchModel
     * @return
     */
    public Page<Order> findServicePointWaitingPartOrder(Page<OrderServicePointSearchModel> page, OrderServicePointSearchModel searchModel) {
        searchModel.setPage(page);
        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = searchModel.getEndAcceptDate() == null ? new Date() : searchModel.getEndAcceptDate();
        Date date;
        if (searchModel.getBeginAcceptDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(searchModel.getBeginAcceptDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -9);//9个月
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
            searchModel.setBeginAcceptDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            searchModel.setQuarters(quarters);
        }
        Date appointDate = DateUtils.getEndOfDay(new Date());
        searchModel.setAppointmentDate(appointDate);
//        List<Order> orderList = servicePointOrderDao.getWaitingPartOrderList(searchModel);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());

        if (orderList != null && orderList.size() > 0) {
            setOrderProperties(orderList);
            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }

        return rtnPage;
    }

    /**
     * 获取网点停滞的工单
     *
     * @param page
     * @param searchModel
     * @return
     */
    public Page<Order> findServicePointPendingOrder(Page<OrderServicePointSearchModel> page, OrderServicePointSearchModel searchModel) {
        searchModel.setPage(page);
        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = searchModel.getEndAcceptDate() == null ? new Date() : searchModel.getEndAcceptDate();
        Date date;
        if (searchModel.getBeginAcceptDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(searchModel.getBeginAcceptDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -9);//9个月
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
            searchModel.setBeginAcceptDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            searchModel.setQuarters(quarters);
        }
        Date appointDate = DateUtils.getEndOfDay(new Date());
        searchModel.setAppointmentDate(appointDate);
//        List<Order> orderList = servicePointOrderDao.getPendingOrderList(searchModel);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());

        if (orderList != null && orderList.size() > 0) {
            setOrderProperties(orderList);
            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }

        return rtnPage;
    }

    /**
     * 设置工单对象的部分属性
     *
     * @param orderList
     */
    private void setOrderProperties(List<Order> orderList) {
        if (orderList != null && orderList.size() > 0) {
            Map<String, Dict> statusMap = MSDictUtils.getDictMap("order_status");
            Map<String, Dict> pendingTypeMap = MSDictUtils.getDictMap("PendingType");
            Map<Long, UrgentLevel> urgentLevelMap = urgentLevelService.findAllMap();
            List<Long> kefuIds = orderList.stream().filter(i->i.getOrderCondition()!=null&&i.getOrderCondition().getKefu()!=null&&i.getOrderCondition().getKefu().getId()!=null)
                    .map(i->i.getOrderCondition().getKefu().getId()).collect(Collectors.toList());
            Map<Long, User> kefuMap = MSUserUtils.getMapByUserIds(kefuIds);
//            Map<Long, User> kefuMap = MSUserUtils.getMapByUserType(User.USER_TYPE_SERVICE);
            List<OrderItem> orderItemList = Lists.newArrayList();
            for (Order item : orderList) {
                item.setItems(OrderItemUtils.fromOrderItemsJson(item.getOrderItemJson()));
                orderItemList.addAll(item.getItems());

                if (item.getOrderCondition() != null) {
                    if (item.getOrderCondition().getServicePoint() != null && item.getOrderCondition().getServicePoint().getId() != null) {
                        ServicePoint servicePoint = servicePointService.getFromCache(item.getOrderCondition().getServicePoint().getId());
                        if (servicePoint != null) {
                            item.getOrderCondition().setServicePoint(servicePoint);
                        }
                        if (item.getOrderCondition().getEngineer() != null && item.getOrderCondition().getEngineer().getId() != null) {
                            Engineer engineer = servicePointService.getEngineerFromCache(item.getOrderCondition().getServicePoint().getId(), item.getOrderCondition().getEngineer().getId());
                            if (engineer != null) {
                                item.getOrderCondition().setEngineer(new User(engineer.getId(), engineer.getName(), engineer.getContactInfo()));
                            }
                        }
                    }
                    if (item.getOrderCondition().getKefu() != null && item.getOrderCondition().getKefu().getId() != null) {
                        User kefu = kefuMap.get(item.getOrderCondition().getKefu().getId());
                        if (kefu != null) {
                            item.getOrderCondition().setKefu(kefu);
                        }
                    }
                }
                Dict statusDict = statusMap.get(item.getOrderCondition().getStatus().getValue());
                if (statusDict != null) {
                    item.getOrderCondition().setStatus(statusDict);
                }
                Dict pendingTypeDict = pendingTypeMap.get(item.getOrderCondition().getPendingType().getValue());
                if (pendingTypeDict != null) {
                    item.getOrderCondition().setPendingType(pendingTypeDict);
                }
                UrgentLevel urgentLevel = urgentLevelMap.get(item.getOrderCondition().getUrgentLevel().getId());
                if (urgentLevel != null) {
                    item.getOrderCondition().setUrgentLevel(urgentLevel);
                }
            }
            OrderItemUtils.setOrderItemProperties(orderItemList, Sets.newHashSet(CacheDataTypeEnum.SERVICETYPE, CacheDataTypeEnum.PRODUCT));
        }
    }

    /**
     * 获取网点完成的工单
     *
     * @param page
     * @param entity
     * @return
     */
    public Page<Order> findServicePointCompletedOrderList(Page<OrderSearchModel> page, OrderSearchModel entity) {
        entity.setPage(page);

        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = entity.getAcceptEndDate() == null ? new Date() : entity.getAcceptEndDate();
        Date date;
        if (entity.getAcceptBeginDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(entity.getAcceptBeginDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -9);//9个月
            if (startDate.getTime() > startDate.getTime()) {
                startDate = date;
            }
            entity.setAcceptBeginDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            entity.setQuarters(quarters);
        }

//        List<Order> orderList = servicePointOrderDao.getCompletedOrderList(entity);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());
        if (orderList != null && orderList.size() > 0) {
            List<Long> orderIdList = orderList.stream().map(LongIDBaseEntity::getId).collect(Collectors.toList());
            Long servicePointId = entity.getServicePoint() == null ? null : entity.getServicePoint().getId();
            Long engineerId = entity.getEngineer() == null ? null : entity.getEngineer().getId();
//            List<OrderDetail> orderDetailList = servicePointOrderDao.getOrderDetailListByOrderIds(orderIdList, servicePointId, engineerId);
            List<OrderDetail> orderDetailList = Lists.newArrayList();
            Map<Long, List<OrderDetail>> orderDetailMap = Maps.newHashMap();
            if (orderDetailList != null && orderDetailList.size() > 0) {
                Map<Long, ServiceType> serviceTypeMap = serviceTypeService.getAllServiceTypeMap();
                Map<Long, Product> productMap = ProductUtils.getAllProductMap();
                for (OrderDetail item : orderDetailList) {
                    item.setServiceType(serviceTypeMap.get(item.getServiceType().getId()));
                    item.setProduct(productMap.get(item.getProductId()));
                    if (orderDetailMap.containsKey(item.getOrderId())) {
                        orderDetailMap.get(item.getOrderId()).add(item);
                    } else {
                        orderDetailMap.put(item.getOrderId(), Lists.newArrayList(item));
                    }
                }
            }

            Map<String, Dict> statusMap = MSDictUtils.getDictMap("order_status");
            Map<String, Dict> pendingTypeMap = MSDictUtils.getDictMap("PendingType");
            Map<Long, UrgentLevel> urgentLevelMap = urgentLevelService.findAllMap();
            List<Long> kefuIds = orderList.stream().filter(i->i.getOrderCondition()!=null&&i.getOrderCondition().getKefu()!=null&&i.getOrderCondition().getKefu().getId()!=null)
                    .map(i->i.getOrderCondition().getKefu().getId()).collect(Collectors.toList());
            Map<Long, User> kefuMap = MSUserUtils.getMapByUserIds(kefuIds);
//            Map<Long, User> kefuMap = MSUserUtils.getMapByUserType(User.USER_TYPE_SERVICE);
            for (Order item : orderList) {
                if (item.getOrderCondition() != null && item.getOrderCondition().getServicePoint() != null &&
                        item.getOrderCondition().getServicePoint().getId() != null) {
                    ServicePoint servicePoint = servicePointService.getFromCache(item.getOrderCondition().getServicePoint().getId());
                    if (servicePoint != null) {
                        item.getOrderCondition().setServicePoint(servicePoint);
                    }
                    if (item.getOrderCondition().getEngineer() != null && item.getOrderCondition().getEngineer().getId() != null) {
                        Engineer engineer = servicePointService.getEngineerFromCache(item.getOrderCondition().getServicePoint().getId(), item.getOrderCondition().getEngineer().getId());
                        if (engineer != null) {
                            item.getOrderCondition().setEngineer(new User(engineer.getId(), engineer.getName(), engineer.getContactInfo()));
                        }
                    }
                }
                if (item.getOrderCondition() != null && item.getOrderCondition().getKefu() != null && item.getOrderCondition().getKefu().getId() != null) {
                    User kefu = kefuMap.get(item.getOrderCondition().getKefu().getId());
                    if (kefu != null) {
                        item.getOrderCondition().setKefu(kefu);
                    }
                }
                Dict statusDict = statusMap.get(item.getOrderCondition().getStatus().getValue());
                if (statusDict != null) {
                    if (item.getOrderCondition().getChargeFlag() == 1) {
                        statusDict = Dict.copyDict(statusDict);
                        statusDict.setLabel("已入账");
                    } else if (Integer.valueOf(item.getOrderCondition().getStatus().getValue()) == 80) {
                        statusDict = Dict.copyDict(statusDict);
                        statusDict.setLabel("待审核");
                    }
                    item.getOrderCondition().setStatus(statusDict);
                }
                Dict pendingTypeDict = pendingTypeMap.get(item.getOrderCondition().getPendingType().getValue());
                if (pendingTypeDict != null) {
                    item.getOrderCondition().setPendingType(pendingTypeDict);
                }
                UrgentLevel urgentLevel = urgentLevelMap.get(item.getOrderCondition().getUrgentLevel().getId());
                if (urgentLevel != null) {
                    item.getOrderCondition().setUrgentLevel(urgentLevel);
                }
                List<OrderDetail> orderDetails = orderDetailMap.get(item.getId());
                if (orderDetails != null) {
                    item.setDetailList(orderDetails);
                }
            }

            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }

        return rtnPage;
    }

    /**
     * 获取网点的退单
     *
     * @param page
     * @param entity
     * @return
     */
    public Page<Order> findServicePointReturnedOrderList(Page<OrderSearchModel> page, OrderSearchModel entity) {
        entity.setPage(page);

        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = entity.getAcceptEndDate() == null ? new Date() : entity.getAcceptEndDate();
        Date date;
        if (entity.getAcceptBeginDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(entity.getAcceptBeginDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -9);//9个月
            if (startDate.getTime() > startDate.getTime()) {
                startDate = date;
            }
            entity.setAcceptBeginDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            entity.setQuarters(quarters);
        }

//        List<Order> orderList = servicePointOrderDao.getReturnedOrderList(entity);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());
        if (orderList != null && orderList.size() > 0) {
            Map<String, Dict> statusMap = MSDictUtils.getDictMap("order_status");
            Map<String, Dict> pendingTypeMap = MSDictUtils.getDictMap("PendingType");
            Map<Long, UrgentLevel> urgentLevelMap = urgentLevelService.findAllMap();
            List<Long> kefuIds = orderList.stream().filter(i->i.getOrderCondition()!=null&&i.getOrderCondition().getKefu()!=null&&i.getOrderCondition().getKefu().getId()!=null)
                    .map(i->i.getOrderCondition().getKefu().getId()).collect(Collectors.toList());
            Map<Long, User> kefuMap = MSUserUtils.getMapByUserIds(kefuIds);
//            Map<Long, User> kefuMap = MSUserUtils.getMapByUserType(User.USER_TYPE_SERVICE);
            for (Order item : orderList) {
                if (item.getOrderCondition() != null && item.getOrderCondition().getServicePoint() != null &&
                        item.getOrderCondition().getServicePoint().getId() != null) {
                    ServicePoint servicePoint = servicePointService.getFromCache(item.getOrderCondition().getServicePoint().getId());
                    if (servicePoint != null) {
                        item.getOrderCondition().setServicePoint(servicePoint);
                    }
                    if (item.getOrderCondition().getEngineer() != null && item.getOrderCondition().getEngineer().getId() != null) {
                        Engineer engineer = servicePointService.getEngineerFromCache(item.getOrderCondition().getServicePoint().getId(), item.getOrderCondition().getEngineer().getId());
                        if (engineer != null) {
                            item.getOrderCondition().setEngineer(new User(engineer.getId(), engineer.getName(), engineer.getContactInfo()));
                        }
                    }
                }
                if (item.getOrderCondition() != null && item.getOrderCondition().getKefu() != null && item.getOrderCondition().getKefu().getId() != null) {
                    User kefu = kefuMap.get(item.getOrderCondition().getKefu().getId());
                    if (kefu != null) {
                        item.getOrderCondition().setKefu(kefu);
                    }
                }
                Dict statusDict = statusMap.get(item.getOrderCondition().getStatus().getValue());
                if (statusDict != null) {
                    item.getOrderCondition().setStatus(statusDict);
                }
                Dict pendingTypeDict = pendingTypeMap.get(item.getOrderCondition().getPendingType().getValue());
                if (pendingTypeDict != null) {
                    item.getOrderCondition().setPendingType(pendingTypeDict);
                }
                UrgentLevel urgentLevel = urgentLevelMap.get(item.getOrderCondition().getUrgentLevel().getId());
                if (urgentLevel != null) {
                    item.getOrderCondition().setUrgentLevel(urgentLevel);
                }
            }

            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }

        return rtnPage;
    }

    /**
     * 网点工单 - 我的工单：所有
     */
    public Page<Order> findServicePointAllOrderList(Page<OrderServicePointSearchModel> page, OrderServicePointSearchModel searchModel) {
        searchModel.setPage(page);

        Date startDate = OrderUtils.getGoLiveDate();
        Date endDate = searchModel.getEndAcceptDate() == null ? new Date() : searchModel.getEndAcceptDate();
        Date date;
        if (searchModel.getBeginAcceptDate() != null) {
            //查询日期是派单日期，分片是按下单分片，所以在此时间上加一个月
            date = DateUtils.addMonth(searchModel.getBeginAcceptDate(), -1);
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
        } else {
            date = DateUtils.addMonth(endDate, -9);//9个月
            if (date.getTime() > startDate.getTime()) {
                startDate = date;
            }
            searchModel.setBeginAcceptDate(startDate);
        }
        List<String> quarters = QuarterUtils.getQuarters(startDate, endDate);
        if (quarters != null && quarters.size() > 0) {
            searchModel.setQuarters(quarters);
        }

//        List<Order> orderList = servicePointOrderDao.getAllOrderList(searchModel);
        List<Order> orderList = Lists.newArrayList();
        Page<Order> rtnPage = new Page<>(page.getPageNo(), page.getPageSize(), page.getCount());
        rtnPage.setOrderBy(page.getOrderBy());
        if (orderList != null && orderList.size() > 0) {
            setOrderProperties(orderList);
            rtnPage.setList(orderList);
        } else {
            rtnPage.setList(Lists.newArrayList());
        }
        return rtnPage;
    }

    //endregion 网点

    /**
     * 判断网点订单是否有投诉
     *
     * @param servicePointId 网点ID
     * @param orderIds       订单ID列表
     * @return
     */
    public Set<Long> getServicePointComplainOrderIdSet(Long servicePointId, List<Long> orderIds) {
        List<Long> ids = complainDao.getOrderIdList(servicePointId, orderIds);
        if (ids == null || ids.size() == 0) {
            return Sets.newHashSet();
        }
        return Sets.newHashSet(ids);
    }
}
