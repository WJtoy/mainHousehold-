<!DOCTYPE html>
<%@ page contentType="text/html;charset=UTF-8" %>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>

<html>
<head>
	<title>配件申请-返件物流信息</title>
	<%@ include file="/WEB-INF/views/include/head.jsp" %>
	<meta name="decorator" content="default"/>
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
	<script src="${ctxStatic}/sd/Order.js?_v=${OrderJsVersion}" type="text/javascript"></script>
	<link href="${ctxStatic}/jquery-upload-file/css/uploadfile.min.css" rel="stylesheet">
	<script src="${ctxStatic}/js/ajaxfileupload.js"></script>
	<script type="text/javascript">
        <%--<%String parentIndex = request.getParameter("parentIndex");%>--%>
        <%--var parentIndex = '<%=parentIndex==null?"":parentIndex %>';--%>
        var parentLayerIndex = parent.layer.getFrameIndex(window.name);
		Order.rootUrl = "${ctx}";
		var this_index = top.layer.index;
		var clickTag = 0;
        var $btnSubmit = $("#btnSubmit");
		$(document).ready(function() {
			$("#buttonUploadLogo").click(function() {
                var $btn = $(self);
                if (clickTag == 1){
                    return false;
                }
                clickTag = 1;
                $btn.attr('disabled', 'disabled');
                $btnSubmit.attr('disabled', 'disabled');
				uploadfile($("#logo"),$("#logo_image"), "fileToUploadlogo2");
				return false;
			});
			
			$("#btnSubmit").click(function(event){
                //console.log("" + new Date().getTime() + " clickTag:" + clickTag);
                if (clickTag == 1){
                    return false;
                }
                clickTag = 1;
                if(Utils.isEmpty($("[id='expressCompany.value']").val())){
                    event.preventDefault();
                    clickTag = 0;
                    layerAlert('请选择快递公司!');
                    return false;
                }
			    if(Utils.isEmpty($("#expressNo").val())){
			        event.preventDefault();
                    clickTag = 0;
                    layerAlert('请输入快递单号!');
			        return false;
				}
				$btnSubmit.attr("disabled", "disabled");
			    var loadingIndex;
			    var ajaxSucess = 0;
				$.ajax({
					type: "POST",
					url: "${ctx}/sd/material/return/saveExpress",
					data:$("#inputForm").serialize(),
                    beforeSend: function () {
                        loadingIndex = layer.msg('正在提交，请稍等...', {
                            icon: 16,
                            time: 0,
                            shade: 0.3
                        });
                    },
                    complete: function () {
                        if(loadingIndex) {
                            layer.close(loadingIndex);
                        }
                        //console.log("" + new Date().getTime() + " clickTag:" + clickTag);
						if(ajaxSucess == 0) {
                            setTimeout(function () {
                                clickTag = 0;
                                $btnSubmit.removeAttr('disabled');
                                //console.log("" + new Date().getTime() + " clickTag:" + clickTag);
                            }, 2000);
                        }
                    },
					success: function (data) {
                        if(ajaxLogout(data)){
                            return false;
                        }
				       if(data && data.success == true){
                           clickTag = 0;
                           ajaxSucess = 1;
				    	   //刷新父窗口
                           var parentIndex = getCookie('layer.parent.id');
                           //console.log("parent:" + parentIndex);
						   if(parentIndex && parentIndex != 0){
                               //var this_index = parent.layer.getFrameIndex(window.name);
                               var layero = $("#layui-layer"+parentIndex,top.document);
                               var iframeCtl = layero.find('iframe');
                               if(iframeCtl && iframeCtl.length>0) {
                                   var iframeWin = top[iframeCtl[0]['name']];
                                   if(typeof iframeWin.reloadApproveList === "function" && iframeWin.reloadApproveList ) {
                                       iframeWin.reloadApproveList();
                                   }else{
                                       iframeWin.location.reloadApproveList();
                                   }
                                   top.layer.close(this_index);//ie下报错
                               }else{
                                   layerMsg('返件成功,请手动关闭此页面!');
                               }
						   }
						   else{
                               layerMsg('返件成功,请手动关闭此页面!');
                           }
				       }
				       else if( data && data.message){
				    	   layerError(data.message,"错误提示");
				       }
				       else{
                           layerError("返件失败","错误提示");
				       }
				       return false;
					},
					error: function (e) {
                        ajaxLogout(e.responseText,null,"返件失败，请重试!");
					}
				});
				return false;
			});
			
			function uploadfile($obj1, $obj1_image, obj2)
			{
				var data = {fileName : $obj1.val()};
				var ajaxSuccess = 0;
				$.ajaxFileUpload(
				{
					url : '${pageContext.request.contextPath}/servlet/Upload?fileName='
							+ $obj1.val(),//处理图片脚本
					secureuri : false,
					data : data,
					fileElementId : obj2,//file控件id
					dataType : 'json',
                    complete: function () {
					    if(ajaxSuccess == 0) {
                            setTimeout(function () {
                                clickTag = 0;
                                $('#buttonUploadLogo').removeAttr('disabled');
                                $btnSubmit.removeAttr('disabled');
                            }, 2000);
                        }
                    },
					success : function(data, status)
					{
                        if(ajaxLogout(data)){
                            return false;
                        }
						$obj1.val(data.fileName);
						$("#orignalName").val(data.origalName);
						if(data.origalName =="" )
						{
						    layerError("请先选择文件，再点击上传","错误提示");
							return true;
						}
                        ajaxSuccess = 1;
						$("#inputForm").attr("action","${ctx}/sd/material/return/saveTempAttachment");
						$("#inputForm").submit();

					},
					error : function(data, status, e)
					{
                        layerError(e, "错误提示");
					}
				});
			}

            $("[id='expressCompany.value']").on('change', function () {
                var companyName = $("[id='expressCompany.value'] option:selected").text();
                $("input[id='expressCompany.label']").val(companyName);
            });
        });

		function closeForm(id,quarter){
			top.layer.open({
				type: 2,
				id: 'layer_material_close',
				zIndex:19891015,
				title:'<font color="red">取消</font>返件申请单',
				content: '${ctx}/sd/material/return/close?id=' + id + "&quarter=" + (quarter || ''),
				area: ['500px', '300px'],
				shade: 0.3,
				maxmin: false,
				success: function(layero,index){
					setCookie('layer.parent.id',this_index);
				},
				end:function(layero,index){}
			});
		}

		function closethislayer(){
			top.layer.close(this_index);
		}
		
		//修改收货地址
		function returnAddressForm(customerId,returnMaterialId,quarter) {
            top.layer.open({
                type: 2,
                id:'layer_returnAddress',
                zIndex:19891016,
                title:'修改返件地址',
                content:"${ctx}sd/material/return/returnAddressForm?customerId="+ customerId + "&returnMaterialId="+returnMaterialId+"&quarter="+quarter + "&parentIndex=" + (parentLayerIndex || ''),
                area: ['800px', '500px'],
                shade: 0.3,
                maxmin: false,
                success: function(layero,index){
                },
                end:function(){

                }
            })
        }

        function setDate(data) {
            $("#receivorAddress").text(data.areaName+data.subAreaName);
        }
		
	</script>
	<style type="text/css">
	  body {background-color:#fff;}
	  html {color:#000;}
	  .form-horizontal{margin-top:10px}
	  .form-horizontal .control-label{width:100px}
	  .form-horizontal .controls{margin-left:120px}
	  .nav-tabs>li {margin-top: 5px;}
	</style>
</head>
<body style="display:inline">
	<sys:message content="${message}" />
	<c:if test="${canAction}">
	<form:form id="inputForm" modelAttribute="materialReturn" action="${ctx}/sd/material/return/saveExpress" method="post" class="form-horizontal">
		<form:hidden path="id" />
		<form:hidden path="orderId" />
		<form:hidden path="applyType.label" />
		<form:hidden path="applyType.value" />
		<form:hidden path="status.label" />
		<form:hidden path="quarter" />
		<input type="hidden" name="createDate" value="${fns:formatDate(materialReturn.createDate,"yyyy-MM-dd HH:mm:ss")}" />
		<form:hidden path="remarks" cssClass="form-horizontal" />
		<div class="row-fluid">
			<div class="span4">
				<div class="control-group">
					<label class="control-label">返件单号:</label>
					<div class="controls">
						<label>${materialReturn.returnNo}</label>
					</div>
				</div>
			</div>
			<div class="span4">
				<div class="control-group">
				<label class="control-label">状态:</label>
					<div class="controls">
							<label>${materialReturn.status.label}</label>
					</div>
				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span4">
				<div class="control-group">
					<label class="control-label">申请时间:</label>
					<div class="controls">
						<span><fmt:formatDate value="${materialReturn.createDate}" pattern="yyyy-MM-dd HH:mm"/> </span>
					</div>
				</div>
			</div>
			<div class="span7">
				<div class="control-group">
					<label class="control-label">返件地址:</label>
					<div class="controls">
						<span id="receivorAddress">${materialReturn.receivorAddress}</span>
						<c:if test="${materialReturn.status.value==2}">
							<a href="javascript:returnAddressForm('${customerId}','${materialReturn.id}','${materialReturn.quarter}')" style="margin-left: 20px"><i class="icon-edit">修改</i></a>
						</c:if>
					</div>
				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span4">
				<div class="control-group">
					<label class="control-label">快递公司:</label>
					<div class="controls">
						<c:choose>
							<c:when test="${materialReturn.status.value eq '2'}">
								<form:select path="expressCompany.value" cssClass="input-medium required">
									<form:option value="" label="请选择" />
									<form:options items="${fns:getDictListFromMS('express_type')}" itemLabel="label" itemValue="value" htmlEscape="false"/><%-- 切换为微服务 --%>
								</form:select>
								<input type="hidden" id="expressCompany.label" name="expressCompany.label" />
							</c:when>
							<c:otherwise>
								<label>${materialReturn.expressCompany.label}</label>
							</c:otherwise>
						</c:choose>
					</div>
				</div>
			</div>
			<div class="span4">
				<div class="control-group">
					<label class="control-label">快递单号:</label>
					<div class="controls">
						<c:choose>
							<c:when test="${materialReturn.status.value eq '2'}">
								<form:input path="expressNo" htmlEscape="false" cssClass="required" maxlength="20" />
							</c:when>
							<c:otherwise>
								<%--<label>${materialReturn.expressNo }</label>--%>
								<a href="http://www.kuaidi100.com/chaxun?com=${materialReturn.expressCompany.value}&nu=${materialReturn.expressNo }" target="_blank" title="点击进入快递100">
										${materialReturn.expressNo }
								</a>
							</c:otherwise>
						</c:choose>
					</div>
				</div>
			</div>
		</div>
		<c:if test="${ empty materialReturn.expressNo && materialReturn.status.value eq '2'}">
		<div class="row-fluid">
			<div class="span8">
				<div class="control-group">
					<label class="control-label"></label>
					<div class="controls">
						<input id="btnSubmit" class="btn btn-primary" type="button" value="保 存" />&nbsp;&nbsp;&nbsp;
<%--						<input id="btnCancel" class="btn btn-danger" title="将驳回返件单" type="button" value="取 消" onclick="closeForm('${materialReturn.id}','${materialReturn.quarter}');"/>&nbsp;&nbsp;--%>
						<input id="btnClose" class="btn btn-primary" title="关闭窗口" type="button" value="关 闭" onclick="closethislayer();"/>
					</div>
				</div>
			</div>
		</div>
		</c:if>
		<c:if test="${materialReturn.items != null and materialReturn.items.size()>0}">
		<ul class="nav nav-tabs">
			<li class="active">
				<a href="#">配件列表</a>
			</li>
		</ul>
		<table id="tbMaterial" width="100%" border="0" class="table table-striped table-bordered table-condensed" style="margin-bottom: 0px;">
			<thead>
			<tr>
				<th width="60px">序号</th>
				<th>配件名</th>
				<th width="80px">数量</th>
			</tr>
			</thead>
			<tbody>
			<c:forEach items="${materialReturn.items}" var="item" varStatus="i" begin="0">
				<c:set var="index" value="${i.index+1}"></c:set>
			<tr>
				<td>${index}</td>
				<td>${item.material.name}</td>
				<td>${item.qty}</td>
			</tr>
			</c:forEach>
			<tbody>
		</table>
		</c:if>
		<c:if test="${ empty materialReturn.expressNo && materialReturn.status.value eq '2'}">
			<ul class="nav nav-tabs" style="margin-top: 5px;">
				<li class="active">
					<a href="#">返件照片上传</a>
				</li>
			</ul>
			<div>
				<img id="logo_image" class="logo_image" alt="" />
				<input name="logo" id="logo" type="hidden"  htmlEscape="false" />
				<input name="orignalName" id="orignalName" type="hidden" htmlEscape="false" />
				<input id="fileToUploadlogo2" type="file" style="width: 400px;height: 50px;font-size: 12pt;"
					size="20" name="fileToUploadlogo2" value="${fileToUploadlogo}" >
				<button id="buttonUploadLogo" type="button" class="btn">上传</button>
			</div>
			<div class="alert" style="margin-top: 5px;">
				<strong>注意!</strong> 如需上传附件，请先上传。单据保存后不能上传附件。
			</div>
		</c:if>
		<c:if test="${materialReturn.attachments != null and materialReturn.attachments.size()>0}">
		<ul class="nav nav-tabs" style="margin-top: 5px;">
			<li class="active">
				<a href="#">返件图片列表</a>
			</li>
		</ul>
		<table width="100%" border="0" class="table table-striped table-bordered table-condensed" style="margin-bottom: 0px;">
			<thead>
				<tr>
					<th width="85%">附件图片</th>
					<th width="15%">上传时间</th>
				</tr>
			</thead>
			<tbody>
				<c:forEach items="${materialReturn.attachments}" var="attach" varStatus="i" begin="0">
					<c:set var="index" value="${i.index+1}"></c:set>
					<tr>
						<td><img alt="" title="${attach.remarks}" src="${ctxUpload}/${attach.filePath}" style="max-width: 800px;">
						</td>
						<td>
							<fmt:formatDate value="${attach.createDate}" pattern="yyyy-MM-dd HH:mm"/>
						</td>
					</tr>
				</c:forEach>
			<tbody>
		</table>
		</c:if>
	</form:form>
	</c:if>
</body>
</html>