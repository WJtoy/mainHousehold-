<!DOCTYPE html>
<%@ page contentType="text/html;charset=UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>
<html>
<head>
    <%@ include file="/WEB-INF/views/include/head.jsp" %>
    <title>安维管理</title>
    <meta name="decorator" content="default" />
    <%@include file="/WEB-INF/views/include/dialog.jsp"%>
    <link href="${ctxStatic}/jquery.darktooltip/darktooltip.min.css" type="text/css" rel="stylesheet" />
    <script src="${ctxStatic}/jquery.darktooltip/jquery.darktooltip.min.js" type="text/javascript"></script>
    <style type="text/css">
        .sort {color: #0663A2;cursor: pointer;}
        .form-horizontal .control-label {width: 70px;}
        .form-horizontal .controls { margin-left: 80px;}
        .form-search .ul-form li label {width: auto;}
    </style>
    <%@ include file="/WEB-INF/views/include/pageSearch.jsp" %>
    <script type="text/javascript">
        top.layer.closeAll();
        $(document).ready(function() {
            $('a[data-toggle=tooltip]').darkTooltip();
            $('a[data-toggle=tooltipeast]').darkTooltip({gravity:'east'});
        });

        function resetPassword(id){
            if (id == undefined || id=='' || id == '0') {
                layerError('参数错误', '错误提示',true);
                return false;
            }

            top.layer.confirm("重置密码后，安维需要重新登录，<br/>确定要<font color='blue'>重置</font>密码吗?", {icon: 3, title:'系统确认'}, function(index){
                top.layer.close(index);//关闭本身
                // do something
                var data = {id:id};
                $.ajax({
                    cache: false,
                    type: "POST",
                    url: "${ctx}/md/engineerForSP/resetPassword",
                    data: data,
                    success: function (data) {
                        if (data.success){
                            layerMsg("密码已重置成功。<br/>新的密码就是您的手机号<font color='#ff4500'>后六位</font>。",true)
                        }
                        else{
                            layerError(data.message,"错误提示",true);
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        layerError(thrownError,"错误提示",true);
                    }
                });
            },function(index){
                //cancel
            });
            return false;
        }

        function pointSelect_callback(data){
            $("[id^='servicePoint.servicePointNo']").val(data.servicePointNo);
        }

        function upgrade(id)
        {
            top.$.jBox.open("iframe:" + "${ctx}/md/engineerForSP/upgrade?id=" + id, "升级网点", 800, 600,
                {
                    top : '10px',
                    buttons : {},
                    loaded : function(h)
                    {
                        $(".jbox-content", h).css("overflow-y","hidden");
                        $("#jbox-iframe", h).prop("height", "98%");
                    }
                });
        }

        function editEngineer(type,id) {
            var h = $(top.window).height();
            var w = $(top.window).width();
            var text = "添加师傅";
            var url = "${ctx}/md/engineerForSP/form";
            var area = ['820px',(h-80)+'px'];
            if(type == 2){
                text = "修改师傅";
                url = "${ctx}/md/engineerForSP/form?id=" + id;
                area = ['820px',(h-180)+'px'];
            }
            top.layer.open({
                type: 2,
                id:"engineer",
                zIndex:19891015,
                title:text,
                content: url,
                area: area,
                shade: 0.3,
                maxmin: false,
                success: function(layero,index){
                },
                end:function(){
                }
            });
        }
    </script>
</head>
<body>
<ul class="nav nav-tabs">
    <li class="active"><a href="javascript:;">师傅</a></li>
</ul>
<c:set var="currentuser" value="${fns:getUser() }" />
<c:set var="isSystemUser" value="${currentuser.isSystemUser()}" />
<form:form id="searchForm" modelAttribute="engineer" action="${ctx}/md/engineerForSP" method="POST" class="breadcrumb form-search">
    <form:hidden path="firstSearch" />
    <input id="pageNo" name="pageNo" type="hidden" value="${page.pageNo}" />
    <input id="pageSize" name="pageSize" type="hidden" value="${page.pageSize}" />
    <input id="orderBy" name="orderBy" type="hidden" value="${engineer.orderBy}" />
    <ul class="ul-form">
        <%--<li>--%>
            <%--<label>网点编号：</label>--%>
            <%--<form:input path="servicePoint.servicePointNo" readonly="true" htmlEscape="false" class="input-small" maxlength="20" />--%>
        <%--</li>--%>
        <%--<li>--%>
            <%--<label>网点名称：</label>--%>
            <%--<c:choose>--%>
                <%--<c:when test="${isSystemUser}">--%>
                    <%--<md:pointselectlayer id="servicePoint" name="servicePoint.id" value="${engineer.servicePoint.id}" labelName="servicePointNo.name" labelValue="${engineer.servicePoint.name}"--%>
                                         <%--width="1200" height="780" callbackmethod="pointSelect_callback" title="选择安维网点" areaId="" hidePhone="1" cssClass="required"/>--%>
                <%--</c:when>--%>
                <%--<c:otherwise>--%>
                    <%--<form:input path="servicePoint.name" readonly="true" htmlEscape="false" class="input-small" />--%>
                    <%--<form:hidden path="servicePoint.id" />--%>
                <%--</c:otherwise>--%>
            <%--</c:choose>--%>
        <%--</li>--%>
        <li>
            <label>师&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;傅：</label>
            <form:input path="name" htmlEscape="false" maxlength="20" class="input-mini" style="width: 120px"/>
        </li>
        <li>
            <label>师傅手机：</label>
            <form:input path="contactInfo" htmlEscape="false" maxlength="20" class="input-small" />
        </li>
        <%--<li>--%>
            <%--<label>账号类型：</label>--%>
            <%--<form:select path="masterFlag" class="input-small">--%>
                <%--<form:option value="-1">所有</form:option>--%>
                <%--<form:option value="1">主账号</form:option>--%>
                <%--<form:option value="0">子账号</form:option>--%>
            <%--</form:select>--%>
        <%--</li>--%>
        <%--<li>--%>
            <%--<label>手机接单：</label>--%>
            <%--<form:select path="appFlag" class="input-small">--%>
                <%--<form:option value="-1">所有</form:option>--%>
                <%--<form:option value="1">是</form:option>--%>
                <%--<form:option value="0">否</form:option>--%>
            <%--</form:select>--%>
        <%--</li>--%>
        <shiro:hasPermission name="md:engineer:view">
            <li class="btns"><input id="btnSubmit" class="btn btn-primary" type="submit" onclick="return setPage();" value="查询" /></li>
            <li class="clearfix"></li>
        </shiro:hasPermission>
    </ul>
</form:form>

<shiro:hasPermission name="md:engineerForSP:edit">
    <button style="margin-top: 15px;margin-bottom: 15px;border-radius: 4px;border:1px solid;border-color:#C0C0C0;background-color: rgb(238,238,238);width: 120px;height: 30px" onclick="editEngineer(1,null)">
        <i class="icon-plus-sign"></i>&nbsp;添加师傅
    </button>
</shiro:hasPermission>
<sys:message content="${message}" />
<shiro:hasPermission name="md:engineerForSP:view">
    <table id="contentTable" class="table table-striped table-bordered table-condensed table-hover table-hover">
        <thead>
        <tr>
            <th width="55">序号</th>
            <th width="100">网点编号</th>
            <th width="140">网点名称</th>
            <th width="100">师傅</th>
            <th width="80">手机</th>
            <th width="160">师傅地址</th>
            <th width="160">收件地址</th>
            <th width="30">QQ</th>
            <th width="40">等级</th>
            <th width="50">派单量</th>
            <th width="40">评分</th>
            <th width="45">账号类型</th>
            <th width="60">手机接单</th>
            <th width="100">覆盖区域</th>
            <c:if test="${isSystemUser}">
                <th width="130">备注</th>
            </c:if>
            <th width="160">操作</th>
        </tr>
        </thead>
        <tbody>
        <c:forEach items="${page.list}" var="model">
            <c:set var="index" value="${index+1}" />
            <tr id="${model.id}">
                <td>${index+(page.pageNo-1)*page.pageSize}</td>
                <td>${model.servicePoint.servicePointNo}</td>
                <td>${model.servicePoint.name}</td>
                <td>${model.name}</td>
                <td>${model.contactInfo}</td>
                <td><a href="javascript:" data-toggle="tooltip"  data-tooltip="${model.address}">${fns:abbr(model.address,30)}</a></td>
                <td><a href="javascript:" data-toggle="tooltip"  data-tooltip="${model.engineerAddress.address}">${fns:abbr(model.engineerAddress.address,25)}</a></td>
                <td>${model.qq}</td>
                <td>${model.level.label}</td>
                <td>${model.planCount}</td>
                <td>${model.grade}</td>
                <td>${model.masterFlag eq 1?'主账号':'子账号'}</td>
                <td>${model.appFlag eq 1?'是':'否'}</td>
                <td><a href="javascript:" data-toggle="tooltip"  data-tooltip="${model.areas}">${fns:abbr(model.areas,20)}</a></td>
                <c:if test="${isSystemUser}">
                    <td><a href="javascript:" data-toggle="tooltip"  data-tooltip="${model.remarks}">${fns:abbr(model.remarks,20)}</a></td>
                </c:if>
                <td>
                    <shiro:hasPermission name="md:engineerForSP:edit">
                        <%--<a href="${ctx}/md/engineer/form?id=${model.id}">修改</a>--%>
                        <a href="javascript:editEngineer(2,'${model.id}')">修改</a>
                    </shiro:hasPermission>
                    <shiro:hasPermission name="md:engineerForSP:resetpassword">
                        <a href="javascript:;" onclick="resetPassword('${model.id}');">重置密码</a>
                    </shiro:hasPermission>
                    <shiro:hasPermission name="md:engineerForSP:stop">
                        <c:choose>
                            <c:when test="${model.delFlag==0}">
                                <a href="${ctx}/md/engineerForSP/delete?id=${model.id}&pointId=${model.servicePoint.id}" onclick="return layerConfirmx('确认要停用该安维人员吗？', this.href)">停用</a>
                            </c:when>
                            <c:otherwise>
                                <a href="${ctx}/md/engineerForSP/enable?id=${model.id}&pointId=${model.servicePoint.id}" onclick="return layerConfirmx('确认要启用该安维人员吗？', this.href)">启用</a>
                            </c:otherwise>
                        </c:choose>
                    </shiro:hasPermission>
                    <shiro:hasPermission name="md:engineerForSP:upgrade">
                        <a href="javascript:;" onclick="upgrade(${model.id});" title="升级为网点">升级</a>
                    </shiro:hasPermission>
                </td>
            </tr>
        </c:forEach>
        </tbody>
    </table>
    <div class="pagination">${page}</div>
</shiro:hasPermission>
</body>
</html>
