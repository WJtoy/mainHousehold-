<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 返件 -->
<mapper namespace="com.wolfking.jeesite.modules.sd.dao.OrderMaterialReturnDao">
    <!-- 单头 -->
    <resultMap id="MaterialReturnHeadResult" type="MaterialReturn">
        <id property="id" column="id"/>
        <result property="quarter" column="quarter" />
        <result property="masterId" column="master_id"/>
        <result property="returnNo" column="return_no"/>
        <result property="orderId" column="order_id"/>
        <result property="productId" column="product_id"/>
        <result property="totalPrice" column="total_price"/>
        <result property="remarks" column="remarks"/>
        <result property="createDate" column="create_date"/>
        <!-- order -->
        <result property="orderNo" column="order_no"/>
        <result property="thrdNo" column="thrd_no"/>
        <result property="orderCreator" column="order_creator"/>
        <!-- user -->
        <result property="userName" column="user_name"/>
        <result property="userPhone" column="user_phone"/>
        <result property="userAddress" column="user_address"/>
        <result property="expressNo" column="express_no"/>
        <!-- receivor -->
        <result property="receivor" column="receivor"/>
        <result property="receivorPhone" column="receivor_phone"/>
        <result property="receivorAddress" column="receivor_address"/>
        <result property="signAt" column="sign_at"/>
        <result property="receiverAreaId" column="receiver_area_id"/>
        <!-- close -->
        <result property="closeDate" column="close_date"/>
        <result property="closeRemark" column="close_remark"/>
        <!-- pending -->
        <result property="pendingDate" column="pending_date"/>
        <result property="pendingContent" column="pending_content"/>

        <association property="customer"  column="master_customer" javaType="Customer" >
            <result property="id" column="customer_id"/>
        </association>
        <association property="product"  column="master_product" javaType="Product" >
            <result property="id" column="product_id"/>
        </association>
        <association property="pendingType"  column="master_pendingType" javaType="Dict" >
            <result property="value" column="pending_type"/>
        </association>
        <association property="area"  column="master_area" javaType="Area" >
            <result property="id" column="area_id"/>
        </association>
        <association property="subArea"  column="master_subArea" javaType="Area" >
            <result property="id" column="sub_area_id"/>
        </association>
        <association property="applyType"  column="master_applyType" javaType="Dict" >
            <result property="value" column="apply_type"/>
        </association>
        <association property="status"  column="master_status" javaType="Dict" >
            <result property="value" column="status_value"/>
        </association>
        <association property="expressCompany"  column="master_expressCompany" javaType="Dict" >
            <result property="value" column="express_company"/>
        </association>
        <association property="createBy"  column="detail_createBy" javaType="User" >
            <id property="id" column="create_by"/>
        </association>
        <association property="closeBy"  column="detail_closeBy" javaType="User" >
            <id property="id" column="close_by"/>
        </association>
    </resultMap>

    <!-- 包含单头，单身 -->
    <resultMap id="MaterialReturnFormResult" type="MaterialReturn" extends="MaterialReturnHeadResult">
        <collection property="items" ofType="MaterialReturnItem">
            <id property="id" column="item_id"/>
            <result property="qty" column="item_qty"/>
            <result property="price" column="item_price"/>
            <result property="totalPrice" column="item_total_price"/>
            <association property="material"  column="item_material" javaType="Material" >
                <id property="id" column="material_id"/>
                <!--                <result property="name" column="material_name"/>-->
            </association>
            <association property="product"  column="item_product" javaType="Product" >
                <id property="id" column="item_product_id"/>
            </association>
        </collection>
    </resultMap>

    <!-- 包含单头，单身及图片 -->
    <resultMap id="MaterialReturnResult" type="MaterialReturn" extends="MaterialReturnFormResult">
        <collection property="attachments" ofType="MaterialAttachment">
            <id property="id" column="attachment_id"/>
            <result property="filePath" column="attachment_filePath"/>
            <result property="remarks" column="attachment_remarks"/>
        </collection>
    </resultMap>


    <!-- 读取订单返件状态信息，判断是否可客评 -->
    <select id="getMaterialReturnListForGrade" resultType="MaterialReturn">
        select
            m.id,
            m.status as 'status.value',
            m.master_id
        from sd_material_return m
        where
            <if test="quarter != null and quarter != ''.toString()">m.quarter = #{quarter} and</if>
            m.order_id = #{orderId}
    </select>

    <!-- 返回订单下的返件基本信息列表(包含明细及图片) -->
    <select id="findMaterialReturnListByOrderId" resultMap="MaterialReturnResult">
        SELECT
            m.id ,
            m.quarter,
            m.return_no,
            m.order_id,
            m.product_id,
            m.status AS status_value,
            m.master_id,
            m.total_price,
            m.apply_type,
            m.express_company,
            m.express_no,
            m.create_by,
            m.create_date ,
            m.remarks,
            m.sign_at,
            ac.id AS attachment_id,
            ac.file_path AS attachment_filePath ,
            ac.remarks AS attachment_remarks ,
            i.id AS item_id ,
            i.material_id,
            i.product_id as item_product_id,
            i.qty AS item_qty,
            i.price as item_price,
            i.total_price as item_total_price
        from sd_material_return m
        left join sd_material_return_item i
        on <if test="quarter != null and quarter != ''.toString()"> m.quarter = #{quarter} and i.quarter = #{quarter} and</if>
            m.id = i.form_id
        left join sd_materialmaster_attachment ma
            on <if test="quarter != null and quarter != ''.toString()"> ma.quarter = #{quarter} and</if> m.id = ma.materialmaster_id
        left join sd_material_attachment ac
            on <if test="quarter != null and quarter != ''.toString()"> ac.quarter = #{quarter} and</if> ma.attachment_id = ac.id
        where
            <if test="quarter != null and quarter != ''.toString()"> m.quarter = #{quarter} and</if>
            m.order_id = #{orderId}
        order by m.id
    </select>

    <!-- 返回订单下的返件列表,不包含图片列表 -->
    <select id="findMaterialReturnListNoAttachByOrderId" resultMap="MaterialReturnFormResult">
        SELECT
            m.id,
            m.quarter,
            m.return_no,
            m.order_id,
            m.status AS status_value,
            m.master_id,
            m.total_price,
            m.apply_type,
            m.product_id,
            m.express_company,
            m.express_no,
            m.create_by,
            m.create_date,
            m.remarks,
            m.order_creator,
            m.sign_at,
            <if test="withOrder != null and withOrder == 1">
                m.order_no,
                m.thrd_no,
                m.customer_id,
                m.user_name,
                m.user_phone,
                m.area_id,
                m.sub_area_id,
                m.user_address,
            </if>
            <if test="withPending != null and withPending == 1">
                m.pending_type,
                m.pending_date,
                m.pending_content,
            </if>
            <if test="withReceivor != null and withReceivor == 1">
                m.receivor,
                m.receivor_phone,
                m.receivor_address,
            </if>
            <if test="withClose != null and withClose == 1">
                m.close_by,
                m.close_date,
                m.close_remark,
            </if>
            i.id AS item_id ,
            i.material_id,
            i.product_id as item_product_id,
            i.qty AS item_qty,
            i.price as item_price,
            i.total_price as item_total_price
        from sd_material_return m
        left join sd_material_return_item i
        on <if test="quarter != null and quarter != ''.toString()"> m.quarter = #{quarter} and i.quarter = #{quarter} and</if>
            m.id = i.form_id
        where <if test="quarter != null and quarter != ''.toString()"> m.quarter = #{quarter} and </if>
            m.order_id = #{orderId}
        order by m.id
    </select>

    <!-- 返件申请单单头 -->
    <select id="findMaterialReturnHeadListByOrderId" resultMap="MaterialReturnHeadResult">
        SELECT
            m.id,
            m.quarter,
            m.return_no,
            m.order_id,
            m.status AS status_value,
            m.master_id,
            m.total_price,
            m.apply_type,
            m.product_id,
            m.express_company,
            m.express_no,
            m.create_by,
            m.create_date,
            m.remarks,
            m.order_creator,
            m.sign_at,
            <if test="withOrder != null and withOrder == 1">
                m.order_no,
                m.thrd_no,
                m.customer_id,
                m.user_name,
                m.user_phone,
                m.area_id,
                m.sub_area_id,
                m.user_address,
            </if>
            <if test="withPending != null and withPending == 1">
                m.pending_type,
                m.pending_date,
                m.pending_content,
            </if>
            <if test="withReceivor != null and withReceivor == 1">
                m.receivor,
                m.receivor_phone,
                m.receivor_address,
            </if>
            <if test="withClose != null and withClose == 1">
                m.close_by,
                m.close_date,
                m.close_remark,
            </if>
        from sd_material_return m
        where <if test="quarter != null and quarter != ''.toString()"> m.quarter = #{quarter} and </if>
            m.order_id = #{orderId}
    </select>

    <!-- 按id取得返件单（不包含图片） -->
    <select id="getReturnFormById" resultMap="MaterialReturnFormResult">
        SELECT
            m.id,
            m.quarter,
            m.return_no,
            m.order_id,
            m.status AS status_value,
            m.master_id,
            m.total_price,
            m.apply_type,
            m.product_id,
            m.express_company,
            m.express_no,
            m.create_by,
            m.create_date,
            m.remarks,
            m.order_creator,
            m.sign_at,
            m.receiver_area_id,
            <if test="withOrder != null and withOrder == 1">
            m.order_no,
            m.thrd_no,
            m.customer_id,
            m.user_name,
            m.user_phone,
            m.area_id,
            m.sub_area_id,
            m.user_address,
            </if>
            <if test="withPending != null and withPending == 1">
            m.pending_type,
            m.pending_date,
            m.pending_content,
            </if>
            <if test="withReceivor != null and withReceivor == 1">
            m.receivor,
            m.receivor_phone,
            m.receivor_address,
            </if>
            <if test="withClose != null and withClose == 1">
            m.close_by,
            m.close_date,
            m.close_remark,
            </if>
            i.id AS item_id,
            i.material_id,
            i.product_id as item_product_id,
            i.qty AS item_qty,
            i.price as item_price,
            i.total_price as item_total_price
        from sd_material_return m
        left join sd_material_return_item i
        on <if test="quarter != null and quarter != ''.toString()">m.quarter = #{quarter} and</if>
            m.id = i.form_id
        where
        <if test="quarter != null and quarter != ''.toString()">m.quarter = #{quarter} and </if>
        <choose>
            <when test="id != null">
                m.id = #{id}
            </when>
            <when test="masterId != null">
                m.master_id = #{masterId}
            </when>
            <otherwise></otherwise>
        </choose>
        limit 1000
    </select>

    <!-- 配件返件单单头 -->
    <select id="getMaterialReturnHeadById" resultMap="MaterialReturnHeadResult">
        SELECT
            m.id,
            m.quarter,
            m.return_no,
            m.order_id,
            m.order_no,
            m.status AS status_value,
            m.master_id,
            m.total_price,
            m.apply_type,
            m.product_id,
            m.express_company,
            m.express_no,
            m.create_by,
            m.create_date,
            m.remarks,
            m.order_creator,
            m.sign_at
        <if test="withOrder != null and withOrder == 1">
            ,m.thrd_no,
            m.customer_id,
            m.user_name,
            m.user_phone,
            m.area_id,
            m.sub_area_id,
            m.user_address
        </if>
        <if test="withPending != null and withPending == 1">
            ,m.pending_type,
            m.pending_date,
            m.pending_content
        </if>
        <if test="withReceivor != null and withReceivor == 1">
            ,m.receivor,
            m.receivor_phone,
            m.receivor_address
        </if>
        <if test="withClose != null and withClose == 1">
            ,m.close_by,
            m.close_date,
            m.close_remark
        </if>
        from sd_material_return m
        where
            <if test="quarter != null and quarter != ''.toString()">m.quarter = #{quarter} and</if>
            <choose>
                <when test="id != null">
                    m.id = #{id}
                </when>
                <when test="masterId != null">
                    m.master_id = #{masterId}
                </when>
                <otherwise></otherwise>
            </choose>
        limit 1
    </select>
    <!-- 图片 -->
    <select id="findAttachementsByReturnId" resultType="MaterialAttachment">
        select
            a.id,a.file_path,a.create_date,a.remarks
        from
            sd_material_attachment a
        inner join sd_materialmaster_attachment m
        on	<if test="quarter != null and quarter != ''.toString()">
            m.quarter = #{quarter}  and a.quarter = #{quarter} and
        </if>
            a.id = m.attachment_id
        where
             m.materialmaster_id = #{returnId}
        and  a.del_flag = 0
        order by
            a.create_date
    </select>

    <!-- 未发货返件单数量 -->
    <select id="getNoApprovedMaterialReturnQty" resultType="java.lang.Integer">
        select
            count(id) as qty
        from
            sd_material_return
        where<if test="quarter != null and quarter != ''.toString()">quarter = #{quarter} and</if>
            order_id = #{orderId}
            <![CDATA[ and status < 3 ]]>
    </select>

    <insert id="insertMaterialReturn" useGeneratedKeys="true" keyProperty="id">
        insert into sd_material_return
        (
            id,
            quarter,
            order_id,
            order_no,
            return_no,
            thrd_no,
            product_id,
            product_ids,
            product_names,
            apply_type,
            total_price,
            customer_id,
            user_name,
            user_phone,
            area_id,
            sub_area_id,
            user_address,
            status,
            master_id,
            order_creator,
            create_by,
            create_date,
            remarks,
            receivor,
            receivor_phone,
            receivor_address,
            receiver_province_id,
            receiver_city_id,
            receiver_area_id,
            product_category_id,
            kefu_type,
            province_id,
            city_id
        )
        values(
            #{id},
            #{quarter},
            #{orderId},
            #{orderNo},
            #{returnNo},
            #{thrdNo},
            #{product.id},
            #{productIds},
            #{productNames},
            #{applyType.value},
            #{totalPrice},
            #{customer.id},
            #{userName},
            #{userPhone},
            #{area.id},
            #{subArea.id},
            #{userAddress},
            #{status.value},
            #{masterId},
            #{orderCreator},
            #{createBy.id},
            #{createDate},
            #{remarks},
            #{receivor},
            #{receivorPhone},
            #{receivorAddress},
            #{receiverProvinceId},
            #{receiverCityId},
            #{receiverAreaId},
            #{productCategoryId},
            #{kefuType},
            #{provinceId},
            #{cityId}
        )
    </insert>

    <insert id="insertMaterialReturnItem" >
        insert into sd_material_return_item
        (
            id,form_id,material_id,product_id,qty,price,total_price,create_by,create_date,quarter
        )
        values
        (
        #{id},#{formId},#{material.id},#{product.id},#{qty},#{price},#{totalPrice},#{createBy.id},#{createDate},#{quarter}
        )
    </insert>

    <!-- 图片 -->
    <insert id="insertMaterialAttach">
        insert into sd_material_attachment(
            id,
            order_id,
            file_path,
            remarks,
            create_by,
            create_date,
            quarter
        ) values(
            #{id},
            #{orderId},
            #{filePath},
            #{remarks},
            #{createBy.id},
            #{createDate},
            #{quarter}
        )
    </insert>

    <insert id="insertMaterialMasterAttachMap">
        insert into sd_materialmaster_attachment (
            materialmaster_id,
            attachment_id,
            quarter
        ) values(
            #{returnId},
            #{attachmentId},
            #{quarter}
        )
    </insert>

    <!-- 更新反件申请 -->
    <update id="updateMaterialReturn" parameterType="java.util.HashMap">
        update
            sd_material_return
        <set>
            <if test="status != null and status.value != null and status.value != ''.toString()" >
                status = CONVERT(#{status.value},SIGNED),
            </if>
            <if test="expressCompany != null" >
                express_company = #{expressCompany.value},
            </if>
            <if test="expressNo != null" >
                express_no = #{expressNo},
            </if>
            <if test="sendBy != null" >
                send_by = #{sendBy.id},
            </if>
            <if test="sendDate != null" >
                send_date = #{sendDate},
            </if>
            <if test="updateBy != null" >
                update_by = #{updateBy.id},
            </if>
            <if test="updateDate != null" >
                update_date = #{updateDate},
            </if>
            <if test="closeBy != null" >
            close_by = #{closeBy.id},
            </if>
            <if test="closeDate != null" >
            close_date = #{closeDate},
            </if>
            <if test="closeRemark != null and closeRemark != ''.trim()" >
            close_remark = #{closeRemark},
            </if>
            <if test="signAt != null" >
                sign_at = #{signAt},
            </if>
            <if test="receivor != null" >
                receivor = #{receivor},
            </if>
            <if test="receivorPhone != null" >
                receivor_phone = #{receivorPhone},
            </if>
            <if test="receivorAddress != null" >
                receivor_address = #{receivorAddress},
            </if>
            <if test="receiverAreaId != null" >
                receiver_area_id = #{receiverAreaId},
            </if>
            <if test="receiverCityId != null" >
                receiver_city_id = #{receiverCityId},
            </if>
            <if test="receiverProvinceId != null" >
                receiver_province_id = #{receiverProvinceId},
            </if>
        </set>
        where
            <if test="quarter != null and quarter != ''.toString()">quarter = #{quarter} and</if>
            id = #{id}
    </update>

    <!-- 更新跟踪进度 -->
    <update id="updateMaterialPendingInfo">
        update
          sd_material_return
        SET
            pending_type = #{pendingType.value},
            pending_date = #{pendingDate},
            pending_content = #{pendingContent}
        where
          quarter = #{quarter}
          and id = #{id}
    </update>

    <!-- close -->
    <!-- 人工关闭配件单(驳回)时驳回返件单 -->
    <update id="manuRejectAndCloseReturnForm">
        update
            sd_material_return
        set
            status = #{status},
            close_by = #{closeBy.id},
            close_date = #{closeDate},
            close_remark = #{closeRemark},
            update_by = #{closeBy.id},
            update_date = #{closeDate}
        where
            quarter = #{quarter}
            <choose>
                <when test="id != null">
                    and id = #{id}
                </when>
                <when test="masterId != null">
                    and master_id = #{masterId}
                </when>
                <otherwise>
                    and 1 = 0
                </otherwise>
            </choose>
            and status = 2
    </update>

    <!-- close end -->

    <select id="getMaterialReturnAddress" resultType="MaterialReturn">
         SELECT id,
                receivor,
                receivor_phone,
                receivor_address,
                receiver_province_id,
                receiver_city_id,
                receiver_area_id
         FROM  sd_material_return
         WHERE  id=#{id}
        <if test="quarter!=null and quarter!=''">
         AND    quarter = #{quarter}
        </if>
    </select>

    <update id="saveReturnAddress">
        UPDATE sd_material_return
        SET    receivor = #{receivor},
               receivor_phone = #{receivorPhone},
               receivor_address = #{receivorAddress},
               receiver_province_id = #{receiverProvinceId},
               receiver_city_id = #{receiverCityId},
               receiver_area_id = #{receiverAreaId},
               update_by = #{updateBy.id},
               update_date = #{updateDate}
        WHERE  id=#{id}
    </update>

    <update id="deleteReturnAttachment">
        UPDATE  sd_material_attachment
        SET     del_flag = 1,
                create_date = #{updateDate},
                update_by = #{updateBy}
        WHERE  id = #{id}
        <if test="quarter !=null and quarter !=''">
            and quarter = #{quarter}
        </if>

    </update>
    <select id="getReturnExpressNoAndStatus" resultType="MaterialReturn">
        SELECT express_no,
               status as 'status.value',
               receiver_area_id,
               receivor,
               receivor_phone,
               receivor_address
         FROM  sd_material_return
         WHERE master_id = #{masterId}
        <if test="quarter!=null and quarter !=''">
            and quarter = #{quarter}
        </if>
    </select>

    <update id="saveSign">
        UPDATE sd_material_return
        SET    status = #{status.value},
               sign_at = #{signAt},
               sign_by = #{signBy.id},
               sign_type = #{signType},
               sign_remark = #{signRemark}
        WHERE
               id = #{id}
        <if test="quarter!=null and quarter !=''">
            and quarter = #{quarter}
        </if>
    </update>

    <!--客户查询代签收返件单列表-->
    <select id="findCustomerWaitMaterialReturnList" resultType="MaterialReturn">
        SELECT
            m.id,
            m.quarter,
            m.order_id,
            m.order_no,
            m.customer_id as 'customer.id',
            m.product_ids,
            m.product_names,
            m.apply_type as 'applyType.value',
            m.user_name,
            m.user_phone,
            m.area_id as 'area.id',
            m.sub_area_id as 'subArea.id',
            m.user_address,
            m.express_no,
            m.express_company,
            m.send_by as 'updateBy.id',
            m.send_date as 'updateDate'
        from sd_material_return m
        <where>
            <choose>
                <when test="orderNoSearchType == 1 or isPhone == 1">
                    <if test="orderNoSearchType == 1">
                        AND m.order_no = #{orderNo}
                    </if>
                    <if test="isPhone == 1">
                        AND m.user_phone = #{userPhone}
                    </if>
                    <if test="quarter != null and quarter != ''.toString()">
                        AND m.quarter = #{quarter}
                    </if>
                    <if test="customer != null and customer.id != null and customer.id >0">
                        and m.customer_id = #{customer.id}
                    </if>
                </when>
                <otherwise>
                    m.create_date between #{beginDate} and #{endDate}
                    <if test="expressNo != null and expressNo != ''.trim()">
                        AND m.express_no = #{expressNo}
                    </if>
                    <if test="customer != null and customer.id != null and customer.id >0">
                        and m.customer_id = #{customer.id}
                    </if>
                    <!-- 按客户查询时，不需关联 -->
                    <if test="sales != null and sales > 0 and (customer == null or customer.id == null or customer.id &lt;=0)">
                        and (
                        exists (
                        select 1
                        from md_customer_sales cs
                        where
                        cs.sales_id = #{sales} and cs.customer_id = m.customer_id
                        )
                        <if test="offlineCustomerList != null and offlineCustomerList.size>0">
                            or m.customer_id in <foreach collection="offlineCustomerList" item="cid" index="index" open="(" close=")" separator=",">${cid}</foreach>
                        </if>
                        )
                    </if>
                    <if test="applyType != null and applyType > 0">
                        and m.apply_type = #{applyType}
                    </if>
                </otherwise>
            </choose>
            and m.status = 3
        </where>
        order by
        m.id
    </select>

    <select id="getMaterialReturnStatus" resultType="java.lang.Integer">
        SELECT status
        FROM  sd_material_return
        WHERE id =#{id}
        <if test="quarter!=null and quarter !=''">
            and quarter = #{quarter}
        </if>
    </select>
</mapper>