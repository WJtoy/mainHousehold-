<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wolfking.jeesite.modules.mq.dao.OrderChargeDao">

	<select id="selectRetryList" resultType="com.wolfking.jeesite.modules.mq.entity.OrderCharge">
		select
			id,
			order_id,
			retry_times,
			status,
			description,
			trigger_by,
			trigger_date,
			create_date,
			update_date,
			quarter
		from
			mq_order_charge
		where
			status = 40
			<![CDATA[and retry_times < 3 ]]>
			<choose>
				<when test="startDate != null and endDate != null">
					and trigger_date between #{startDate} and #{endDate}
				</when>
				<when test="startDate != null">
					<![CDATA[ and trigger_date >= #{startDate} ]]>
				</when>
				<when test="endDate != null">
					<![CDATA[ and trigger_date <= #{endDate} ]]>
				</when>
			</choose>
		order by id ASC
		<if test="count !=null">
			limit #{count}
		</if>
	</select>

	<insert id="insert">
		INSERT INTO mq_order_charge(
			id,
			order_id,
			retry_times,
			status,
			description,
			trigger_by,
			trigger_date,
			create_date,
			update_date,
			quarter
		) VALUES (
			#{id},
			#{orderId},
			#{retryTimes},
			#{status},
			#{description},
			#{triggerBy},
			#{triggerDate},
			#{createDate},
			#{updateDate},
			#{quarter}
		)
	</insert>

	<update id="update">
		update
			mq_order_charge
		set
			<if test="retryTimes != null and retryTimes>0">
				retry_times = retry_times + 1,
			</if>
			status = #{status},
			<if test="remarks != null and remarks != ''.toString()">
				description = #{remarks},
			</if>
			update_date = now()
		where
			id = #{id}
	</update>
	
	<delete id="delete">
		DELETE mq_order_charge
		WHERE id = #{id}
	</delete>

</mapper>